<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tanks: Armored Bricks</title>
    <style>
        body { margin: 0; padding: 0; background: #222; overflow: hidden; touch-action: none; font-family: 'Arial', sans-serif; -webkit-user-select: none; user-select: none; }
        canvas { display: block; background: #333; width: 100vw; height: 100vh; }
        #menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .menu-title { font-size: 48px; margin-bottom: 40px; color: #ffcc00; }
        .mode-btn { padding: 15px; font-size: 20px; border: none; border-radius: 8px; background: #444; color: white; cursor: pointer; margin-bottom: 10px; width: 280px; }
        .mode-btn.active { background: #2e7d32; }
        .start-btn { padding: 18px 40px; font-size: 24px; background: linear-gradient(45deg, #2e7d32, #4caf50); color: white; border: none; border-radius: 10px; cursor: pointer; margin-top: 20px; font-weight: bold; }
        .score { position: absolute; width: 100%; text-align: center; font-size: 24px; font-weight: bold; z-index: 100; color: #fff; pointer-events: none; }
        #score2 { top: 160px; } #score1 { bottom: 160px; }
        .joy-zone, .btn-fire { position: fixed; border-radius: 50%; z-index: 200; touch-action: none; }
        .joy-zone { width: 150px; height: 150px; background: rgba(255,255,255,0.05); border: 2px solid #555; }
        .stick { position: absolute; width: 60px; height: 60px; border-radius: 50%; top: 45px; left: 45px; pointer-events: none; background: rgba(255,255,255,0.2); }
        .btn-fire { display: flex; align-items: center; justify-content: center; font-weight: bold; width: 120px; height: 120px; border: 4px solid #333; }
        #p1-fire { background: rgba(0,255,0,0.2); right: 20px; bottom: 20px; }
        #p2-fire { background: rgba(255,0,0,0.2); left: 20px; top: 20px; }
        #p1-joy { left: 20px; bottom: 20px; }
        #p2-joy { right: 20px; top: 20px; }
    </style>
</head>
<body>
    <div id="menu">
        <h1 class="menu-title">БРОНЕТАНКИ</h1>
        <button class="mode-btn active" data-mode="pvp">1 на 1 (PvP)</button>
        <button class="mode-btn" data-mode="pve">Против ИИ (PvE)</button>
        <button class="start-btn" id="start-game">НАЧАТЬ ИГРУ</button>
    </div>

    <div id="score2" class="score">0</div>
    <div id="score1" class="score">0</div>
    <canvas id="gameCanvas"></canvas>

    <div id="p1-controls">
        <div id="p1-fire" class="btn-fire">ОГОНЬ</div>
        <div id="p1-joy" class="joy-zone"><div class="stick" style="border: 2px solid #0f0;"></div></div>
    </div>
    <div id="p2-controls">
        <div id="p2-fire" class="btn-fire">ОГОНЬ</div>
        <div id="p2-joy" class="joy-zone"><div class="stick" style="border: 2px solid #f00;"></div></div>
    </div>

<script>
const CONFIG = {
    TANK: { SPEED: 2.8, HP: 3, COOLDOWN: 400 }, // Огонь стал быстрее
    BULLET: { SPEED: 9 },
    SOS: { SEQ: '...---...', TANK_LIFE: 500 }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let tanks = [], bullets = [], bricks = [], sosTanks = [], isGameActive = false, gameMode = 'pvp';

class Tank {
    constructor(id, color, isBottom) {
        this.id = id; this.color = color; this.isBottom = isBottom;
        this.score = 0; this.reset();
    }
    reset() {
        this.x = canvas.width / 2;
        this.y = this.isBottom ? canvas.height - 80 : 80;
        this.angle = this.isBottom ? -Math.PI/2 : Math.PI/2;
        this.hp = CONFIG.TANK.HP;
        this.dx = 0; this.dy = 0; this.lastShot = 0;
        this.sosBuffer = []; this.lastDown = 0;
        this.isAtBase = true; // Для положения полоски жизни
    }
}

function createBricks() {
    bricks = [];
    const cx = canvas.width / 2;
    const addWall = (x, y, w, h) => {
        for(let i=0; i<w; i++) for(let j=0; j<h; j++) bricks.push({x: x+i*25, y: y+j*15, w: 25, h: 15});
    };
    // П-образные укрытия
    addWall(cx - 75, canvas.height - 180, 6, 1); addWall(cx - 75, canvas.height - 165, 1, 3); addWall(cx + 50, canvas.height - 165, 1, 3);
    addWall(cx - 75, 165, 6, 1); addWall(cx - 75, 105, 1, 4); addWall(cx + 50, 105, 1, 4);
}

function drawTank(t, isSOS = false) {
    ctx.save();
    ctx.translate(t.x, t.y);
    ctx.rotate(t.angle);
    // Гусеницы
    ctx.fillStyle = '#111'; ctx.fillRect(-22, -18, 44, 8); ctx.fillRect(-22, 10, 44, 8);
    // Корпус
    ctx.fillStyle = t.color; ctx.beginPath(); ctx.roundRect(-18, -12, 36, 24, 3); ctx.fill();
    // Башня
    ctx.beginPath(); ctx.arc(-2, 0, 10, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
    // Дуло
    ctx.fillStyle = '#222'; ctx.fillRect(8, -3, 22, 6);
    ctx.restore();

    if (!isSOS) {
        // Полоска жизни
        const offset = t.isAtBase ? 35 : -35; 
        const bx = t.x - 20;
        const by = t.y + (Math.sin(t.angle) * offset) - 30;
        ctx.fillStyle = 'black'; ctx.fillRect(t.x-20, t.y + (t.isAtBase ? 35 : -45), 40, 6);
        ctx.fillStyle = t.hp > 1 ? '#0f0' : '#f00'; ctx.fillRect(t.x-20, t.y + (t.isAtBase ? 35 : -45), (t.hp/CONFIG.TANK.HP)*40, 6);
    }
}

function shoot(t) {
    const now = Date.now();
    if (now - t.lastShot < CONFIG.TANK.COOLDOWN) return;
    bullets.push({ x: t.x + Math.cos(t.angle)*35, y: t.y + Math.sin(t.angle)*35, angle: t.angle, owner: t.id });
    t.lastShot = now;
    t.isAtBase = false;
}

function handleSOS(idx, type) {
    const t = tanks[idx];
    if (type === 'down') t.lastDown = Date.now();
    else {
        const dur = Date.now() - t.lastDown;
        t.sosBuffer.push(dur < 250 ? '.' : '-');
        if (t.sosBuffer.length > 9) t.sosBuffer.shift();
        if (t.sosBuffer.join('').includes(CONFIG.SOS.SEQ)) {
            for(let i=0; i<5; i++) sosTanks.push({x: Math.random()*canvas.width, y: t.isBottom?canvas.height:0, angle: t.angle, color: t.color, owner: t.id, life: CONFIG.SOS.TANK_LIFE});
            t.sosBuffer = [];
        }
    }
}

function update() {
    if (!isGameActive) { requestAnimationFrame(update); return; }
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    bricks.forEach(b => { ctx.fillStyle = '#a52a2a'; ctx.fillRect(b.x, b.y, b.w, b.h); ctx.strokeStyle = '#5d1a1a'; ctx.strokeRect(b.x, b.y, b.w, b.h); });

    tanks.forEach(t => {
        let nx = t.x + t.dx * CONFIG.TANK.SPEED;
        let ny = t.y + t.dy * CONFIG.TANK.SPEED;
        const col = bricks.some(b => nx+20 > b.x && nx-20 < b.x+b.w && ny+20 > b.y && ny-20 < b.y+b.h);
        if (!col && nx > 20 && nx < canvas.width-20 && ny > 20 && ny < canvas.height-20) { t.x = nx; t.y = ny; }
        if (t.dx !== 0 || t.dy !== 0) t.isAtBase = false;
        drawTank(t);
    });

    sosTanks.forEach((s, i) => {
        s.y += s.owner === 0 ? -1 : 1; s.life--;
        drawTank(s, true);
        if (s.life <= 0) sosTanks.splice(i, 1);
    });

    bullets.forEach((b, i) => {
        b.x += Math.cos(b.angle) * CONFIG.BULLET.SPEED; b.y += Math.sin(b.angle) * CONFIG.BULLET.SPEED;
        ctx.fillStyle = 'yellow'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill();
        tanks.forEach(t => {
            if (b.owner !== t.id && Math.hypot(b.x-t.x, b.y-t.y) < 25) {
                bullets.splice(i, 1); t.hp--;
                if (t.hp <= 0) { tanks[b.owner].score++; t.reset(); }
                document.getElementById('score1').textContent = tanks[0].score; document.getElementById('score2').textContent = tanks[1].score;
            }
        });
    });
    requestAnimationFrame(update);
}

// УПРАВЛЕНИЕ (ДЖОЙСТИК №3)
const setupJoystick = (joyId, stickId, tankIdx) => {
    const joy = document.getElementById(joyId);
    const stick = joy.querySelector('.stick');
    const move = (e) => {
        const rect = joy.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        const dx = (touch.clientX - (rect.left + 75)) / 75;
        const dy = (touch.clientY - (rect.top + 75)) / 75;
        const dist = Math.min(1, Math.hypot(dx, dy));
        const angle = Math.atan2(dy, dx);
        if (dist > 0.2) {
            tanks[tankIdx].dx = Math.cos(angle) * dist;
            tanks[tankIdx].dy = Math.sin(angle) * dist;
            tanks[tankIdx].angle = angle;
            stick.style.transform = `translate(${Math.cos(angle)*dist*40}px, ${Math.sin(angle)*dist*40}px)`;
        }
    };
    const stop = () => { tanks[tankIdx].dx = 0; tanks[tankIdx].dy = 0; stick.style.transform = 'none'; };
    joy.addEventListener('touchstart', move); joy.addEventListener('touchmove', move); joy.addEventListener('touchend', stop);
    joy.addEventListener('mousedown', move); window.addEventListener('mouseup', stop);
};

document.getElementById('start-game').onclick = () => {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    tanks = [new Tank(0, '#2e7d32', true), new Tank(1, '#c62828', false)];
    createBricks(); setupJoystick('p1-joy', 'p1-stick', 0); setupJoystick('p2-joy', 'p2-stick', 1);
    isGameActive = true; document.getElementById('menu').style.display = 'none';
};

const setupFire = (id, idx) => {
    const btn = document.getElementById(id);
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); shoot(tanks[idx]); handleSOS(idx, 'down'); });
    btn.addEventListener('touchend', () => handleSOS(idx, 'up'));
    btn.addEventListener('mousedown', () => { shoot(tanks[idx]); handleSOS(idx, 'down'); });
    btn.addEventListener('mouseup', () => handleSOS(idx, 'up'));
};
setupFire('p1-fire', 0); setupFire('p2-fire', 1);

update();
</script>
</body>
</html>
