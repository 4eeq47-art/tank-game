<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>БРОНЕТАНКИ: РЕВОЛЮЦИЯ</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #0a0a0a; overflow: hidden; touch-action: none; font-family: 'Courier New', monospace; }
        canvas { display: block; position: absolute; inset: 0; }
        #bgCanvas { z-index: 1; }
        #gameCanvas { z-index: 5; display: none; }
        
        #menu { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); }
        .m-card { background: #1a1a1a; padding: 40px; border: 4px solid #444; border-radius: 15px; text-align: center; }
        .btn { pointer-events: auto; width: 280px; padding: 18px; margin: 10px; font-size: 22px; font-weight: 900; color: #fff; background: #222; border: 2px solid #555; cursor: pointer; }
        .btn.active { background: #2e7d32; border-color: #aeea00; }
        .start { background: #b71c1c; border-color: #ff5252; font-size: 32px; height: 90px; }
        
        #ui { position: fixed; inset: 0; z-index: 10; pointer-events: none; display: none; }
        .score { position: absolute; width: 100%; text-align: center; font-size: 40px; font-weight: 900; }
        #score2 { top: 110px; transform: rotate(180deg); color: #ff5252; }
        #score1 { bottom: 135px; color: #69f0ae; }
        
        .ctrl { position: absolute; pointer-events: auto; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); }
        .joy { width: 170px; height: 170px; background: rgba(255,255,255,0.05); }
        .fire { width: 130px; height: 130px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #fff; }
        .stick { position: absolute; width: 70px; height: 70px; border-radius: 50%; top: 47px; left: 47px; pointer-events: none; }
        
        #exit-btn { position: fixed; right: 10px; top: 50%; transform: translateY(-50%) rotate(90deg); z-index: 200; padding: 15px 25px; background: #c62828; color: #fff; border: 2px solid #fff; font-weight: 900; display: none; cursor: pointer; pointer-events: auto; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<canvas id="gameCanvas"></canvas>

<div id="menu">
    <div class="m-card">
        <h1 style="color: #ffeb3b; font-size: 50px; margin: 0 0 30px 0;">БРОНЕТАНКИ</h1>
        <button class="btn active" id="pvp-btn">ИГРОК VS ИГРОК</button>
        <button class="btn" id="pve-btn">ИГРОК VS БОТ</button>
        <button class="btn start" id="start-btn">В БОЙ!</button>
    </div>
</div>

<div id="ui">
    <div id="score2" class="score">0</div>
    <div id="score1" class="score">0</div>
    <div id="p1-joy" class="ctrl joy" style="left:40px; bottom:40px;"><div class="stick" style="background: #2e7d32;"></div></div>
    <div id="p1-fire" class="ctrl fire" style="right:40px; bottom:40px; background: rgba(46,125,50,0.5);">ОГОНЬ</div>
    <div id="p2-joy" class="ctrl joy" style="right:40px; top:40px;"><div class="stick" style="background: #c62828;"></div></div>
    <div id="p2-fire" class="ctrl fire" style="left:40px; top:40px; transform: rotate(180deg); background: rgba(198,40,40,0.5);">ОГОНЬ</div>
</div>

<button id="exit-btn">В МЕНЮ</button>

<script>
const bgCvs = document.getElementById('bgCanvas'), gCvs = document.getElementById('gameCanvas');
const bctx = bgCvs.getContext('2d'), gctx = gCvs.getContext('2d');
let W, H, isGame = false, gameMode = 'pvp';
let tanks = [], bullets = [], bricks = [], explosions = [], sosSquad = [];

// --- ТАНК ОБЪЕКТ ---
class Tank {
    constructor(id, color, isBot, isBottom) {
        this.id = id; this.color = color; this.isBot = isBot; this.isBottom = isBottom;
        this.score = 0; this.sosBuf = []; this.reset();
    }
    reset() {
        this.x = W/2; this.y = this.isBottom ? H-100 : 100;
        this.angle = this.isBottom ? -Math.PI/2 : Math.PI/2;
        this.hp = 3; this.dx = 0; this.dy = 0; this.flash = 0; this.dead = false; this.deadT = 0;
        this.lastS = 0; this.stuckT = 0; this.reversing = 0;
    }
}

// --- КЛАССИЧЕСКАЯ ОТРИСОВКА ---
function drawTank(ctx, t) {
    ctx.save(); ctx.translate(t.x, t.y);
    
    // HP Bar (у зеленого сзади, у красного сзади)
    ctx.fillStyle = '#444'; ctx.fillRect(t.isBottom ? 35 : -40, -20, 5, 40);
    ctx.fillStyle = t.id === 0 ? '#69f0ae' : '#ff5252';
    ctx.fillRect(t.isBottom ? 35 : -40, -20 + (40*(1-t.hp/3)), 5, 40*(t.hp/3));

    ctx.rotate(t.angle);
    if(t.dead) ctx.globalAlpha = 0.2;

    // Гусеницы с детализацией
    ctx.fillStyle = '#222';
    ctx.fillRect(-26, -20, 52, 10); ctx.fillRect(-26, 10, 52, 10);
    ctx.fillStyle = '#111';
    for(let i=-22; i<24; i+=8) { ctx.fillRect(i, -20, 2, 10); ctx.fillRect(i, 10, 2, 10); }

    // Корпус
    ctx.fillStyle = t.color; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.roundRect(-22, -16, 44, 32, 3); ctx.fill(); ctx.stroke();
    
    // Башня и дуло
    ctx.beginPath(); ctx.arc(-2, 0, 14, 0, 7); ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#111'; ctx.fillRect(12, -4, 30, 8); // Ствол
    ctx.fillStyle = t.color; ctx.fillRect(38, -7, 10, 14); ctx.strokeRect(38, -7, 10, 14); // Тормоз

    if(t.flash > 0) {
        let g = ctx.createRadialGradient(50, 0, 0, 50, 0, 30);
        g.addColorStop(0, '#fff'); g.addColorStop(1, 'transparent');
        ctx.fillStyle = g; ctx.beginPath(); ctx.arc(50, 0, 30, 0, 7); ctx.fill();
        t.flash--;
    }
    ctx.restore();
}

// --- ЛОГИКА ИИ (ВЫЕЗД ИЗ ТУПИКА) ---
function updateAI(t) {
    const tar = tanks[0];
    const dist = Math.hypot(tar.x - t.x, tar.y - t.y);
    
    if (t.reversing > 0) {
        t.dx = -Math.cos(t.angle); t.dy = -Math.sin(t.angle);
        t.angle += 0.04; t.reversing--;
        return;
    }

    const nextX = t.x + Math.cos(t.angle) * 30, nextY = t.y + Math.sin(t.angle) * 30;
    if (colCheck(nextX, nextY, 20)) {
        t.stuckT++;
        if (t.stuckT > 30) { t.reversing = 60; t.stuckT = 0; }
    } else {
        t.stuckT = 0;
        t.angle = Math.atan2(tar.y - t.y, tar.x - t.x);
        t.dx = Math.cos(t.angle); t.dy = Math.sin(t.angle);
    }
    if (dist < 400 && Math.random() < 0.03) shoot(t);
}

// --- ГЛАВНЫЙ ЦИКЛ ---
function loop() {
    W = window.innerWidth; H = window.innerHeight;
    if (bgCvs.width !== W) bgCvs.width = gCvs.width = W;
    if (bgCvs.height !== H) bgCvs.height = gCvs.height = H;

    if (!isGame) {
        bctx.fillStyle = '#111'; bctx.fillRect(0,0,W,H);
        // Заставка: танки сбоку
        let time = Date.now() * 0.001;
        for(let i=0; i<2; i++) {
            let tx = (time * 100 + i*400) % (W + 200) - 100;
            bctx.fillStyle = '#2e7d32'; bctx.fillRect(tx, H*0.7 + i*50, 80, 25);
            bctx.fillStyle = '#111'; bctx.fillRect(tx+20, H*0.7 + i*50 - 15, 30, 15); // Башня
        }
    } else {
        gctx.fillStyle = '#151515'; gctx.fillRect(0,0,W,H);
        gctx.strokeStyle = '#222'; for(let i=0; i<W; i+=50) { gctx.beginPath(); gctx.moveTo(i,0); gctx.lineTo(i,H); gctx.stroke(); }
        
        bricks.forEach(b => { gctx.fillStyle = '#8d4925'; gctx.fillRect(b.x, b.y, 25, 15); gctx.strokeRect(b.x, b.y, 25, 15); });

        tanks.concat(sosSquad).forEach(t => {
            if(t.dead) { t.deadT++; if(t.deadT > 100) t.reset(); }
            else {
                if(t.isBot) updateAI(t);
                let nx = t.x + t.dx*3.5, ny = t.y + t.dy*3.5;
                if(!colCheck(nx, t.y, 22)) t.x = nx; if(!colCheck(t.x, ny, 22)) t.y = ny;
            }
            drawTank(gctx, t);
        });

        bullets.forEach((b, i) => {
            b.x += Math.cos(b.a)*15; b.y += Math.sin(b.a)*15;
            gctx.fillStyle = '#fff'; gctx.beginPath(); gctx.arc(b.x, b.y, 4, 0, 7); gctx.fill();
            let hit = tanks.find(tk => !tk.dead && b.owner !== tk.id && Math.hypot(b.x-tk.x, b.y-tk.y) < 25);
            if(hit) { hit.hp--; explosions.push({x:b.x, y:b.y, l:15}); if(hit.hp<=0){ hit.dead=true; tanks[b.owner].score++; } bullets.splice(i,1); }
            else if(colCheck(b.x, b.y, 5)) { explosions.push({x:b.x, y:b.y, l:10}); bullets.splice(i,1); }
            if(b.x<0||b.x>W||b.y<0||b.y>H) bullets.splice(i,1);
        });

        explosions.forEach((e, i) => {
            gctx.fillStyle = `rgba(255,200,0,${e.l/15})`;
            gctx.beginPath(); gctx.arc(e.x, e.y, 30-e.l, 0, 7); gctx.fill();
            e.l--; if(e.l<=0) explosions.splice(i,1);
        });

        document.getElementById('score1').innerText = tanks[0].score;
        document.getElementById('score2').innerText = tanks[1].score;
    }
    requestAnimationFrame(loop);
}

function shoot(t) {
    if(t.dead || Date.now() - t.lastS < 300) return;
    bullets.push({x: t.x + Math.cos(t.angle)*45, y: t.y + Math.sin(t.angle)*45, a: t.angle, owner: t.id});
    t.flash = 6; t.lastS = Date.now();
}

function colCheck(x, y, r) {
    if(x<r || x>W-r || y<r || y>H-r) return true;
    return bricks.some(b => x+r > b.x && x-r < b.x+25 && y+r > b.y && y-r < b.y+15);
}

// --- УПРАВЛЕНИЕ ---
const touches = {};
function setupInp() {
    const handle = (e) => {
        if(!isGame) return; e.preventDefault();
        for(let t of e.changedTouches) {
            const x = t.clientX, y = t.clientY;
            if(e.type==='touchstart' || e.type==='touchmove') {
                ['p1-joy','p2-joy'].forEach((id, i) => {
                    const r = document.getElementById(id).getBoundingClientRect();
                    const cx = r.left + 85, cy = r.top + 85;
                    if(Math.hypot(x-cx, y-cy) < 150) {
                        let dx = (x-cx)/85, dy = (y-cy)/85;
                        let a = Math.atan2(dy, dx), d = Math.min(1, Math.hypot(dx, dy));
                        tanks[i].dx = Math.cos(a)*d; tanks[i].dy = Math.sin(a)*d; tanks[i].angle = a;
                        document.getElementById(id).querySelector('.stick').style.transform = `translate(${dx*40}px, ${dy*40}px)`;
                        touches[t.identifier] = {type:'joy', i};
                    }
                });
                ['p1-fire','p2-fire'].forEach((id, i) => {
                    const r = document.getElementById(id).getBoundingClientRect();
                    if(x>r.left && x<r.right && y>r.top && y<r.bottom && e.type==='touchstart') {
                        shoot(tanks[i]);
                        touches[t.identifier] = {type:'fire', i, ts: Date.now()};
                    }
                });
            }
            if(e.type==='touchend') {
                let d = touches[t.identifier];
                if(d) {
                    if(d.type==='joy') { tanks[d.i].dx=0; tanks[d.i].dy=0; document.querySelectorAll('.stick')[d.i].style.transform='none'; }
                    if(d.type==='fire') {
                        let tk = tanks[d.i]; let dur = Date.now()-d.ts;
                        tk.sosBuf.push(dur > 250 ? '-' : '.');
                        if(tk.sosBuf.length > 9) tk.sosBuf.shift();
                        if(tk.sosBuf.join('').includes('...---...')) {
                            for(let k=0; k<3; k++) { let s = new Tank(d.i, tk.color, true, false); s.x=Math.random()*W; s.y=H+100; sosSquad.push(s); }
                            tk.sosBuf = [];
                        }
                    }
                    delete touches[t.identifier];
                }
            }
        }
    };
    ['touchstart','touchmove','touchend'].forEach(n => window.addEventListener(n, handle, {passive:false}));
}

document.getElementById('start-btn').onclick = () => {
    isGame = true; gCvs.style.display = 'block';
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('exit-btn').style.display = 'block';
    tanks = [new Tank(0, '#388e3c', false, true), new Tank(1, '#d32f2f', gameMode==='pve', false)];
    if(gameMode==='pve') { document.getElementById('p2-joy').style.display='none'; document.getElementById('p2-fire').style.display='none'; }
    
    bricks = []; let cx = W/2 - 75;
    const r = (x,y,w,h) => { for(let i=0; i<w; i++) for(let j=0; j<h; j++) bricks.push({x:x+i*26, y:y+j*16}); };
    // Развернутые П-укрытия
    r(cx, 100, 6, 1); r(cx, 116, 1, 3); r(cx+130, 116, 1, 3); // Верхнее (смотрит вниз)
    r(cx, H-116, 6, 1); r(cx, H-164, 1, 3); r(cx+130, H-164, 1, 3); // Нижнее (смотрит вверх)
};

document.getElementById('pvp-btn').onclick = () => { gameMode='pvp'; document.getElementById('pvp-btn').className='btn active'; document.getElementById('pve-btn').className='btn'; };
document.getElementById('pve-btn').onclick = () => { gameMode='pve'; document.getElementById('pve-btn').className='btn active'; document.getElementById('pvp-btn').className='btn'; };
document.getElementById('exit-btn').onclick = () => location.reload();

loop(); setupInp();
</script>
</body>
</html>
