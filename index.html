<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Б Р О Н Е Т А Н К.И.</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; touch-action: none; font-family: 'Courier New', monospace; -webkit-user-select: none; user-select: none; }
        canvas { display: block; background: #1a1a1a; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        #menu-bg { position: fixed; inset: 0; z-index: 2; background: #000; }
        #menu { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .menu-content { display: flex; flex-direction: column; align-items: center; z-index: 4; pointer-events: auto; }
        .menu-title { font-size: clamp(24px, 8vw, 60px); margin-bottom: 40px; color: #ffeb3b; letter-spacing: 8px; text-shadow: 4px 4px 0 #bf360c; font-weight: 900; }
        .mode-btn { padding: 18px; font-size: 22px; border: 3px solid #777; border-radius: 8px; background: #333; color: white; cursor: pointer; width: 320px; margin-bottom: 20px; font-weight: bold; }
        .mode-btn.active { background: #388e3c; border-color: #aeea00; }
        .start-btn { padding: 25px 60px; font-size: 30px; background: #d32f2f; color: white; border: none; cursor: pointer; margin-top: 20px; font-weight: 900; border-radius: 10px; box-shadow: 0 5px 0 #b71c1c; }
        .back-to-menu-btn { position: fixed; top: 50%; left: 15px; transform: translateY(-50%) rotate(-90deg); padding: 10px 20px; background: rgba(0,0,0,0.7); color: #fff; border: 2px solid #555; border-radius: 5px; z-index: 2500; display: none; }
        
        .score { position: absolute; width: 100px; text-align: center; font-size: 28px; font-weight: 900; z-index: 100; color: #fff; pointer-events: none; text-shadow: 2px 2px 0 #000; }
        #score2 { top: 109px; left: 50%; transform: translateX(-50%) rotate(180deg); color: #ff5252; } 
        #score1 { bottom: 136px; left: 50%; transform: translateX(-50%); color: #69f0ae; }
        
        .controls-layer { position: fixed; inset: 0; pointer-events: none; z-index: 2000; }
        .joy-zone, .btn-fire { position: absolute; border-radius: 50%; pointer-events: auto; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); }
        .stick { position: absolute; width: 60px; height: 60px; border-radius: 50%; top: 50px; left: 50px; background: rgba(255,255,255,0.3); pointer-events: none; }
        #p1-joy { left: 40px; bottom: 40px; width: 160px; height: 160px; }
        #p1-fire { right: 40px; bottom: 40px; width: 130px; height: 130px; color: #4caf50; display: flex; align-items: center; justify-content: center; font-weight: 900; }
        #p2-joy { right: 40px; top: 40px; width: 160px; height: 160px; }
        #p2-fire { left: 40px; top: 40px; width: 130px; height: 130px; color: #f44336; display: flex; align-items: center; justify-content: center; font-weight: 900; transform: rotate(180deg); }
    </style>
</head>
<body>
    <canvas id="menu-bg"></canvas>
    <div id="menu">
        <div class="menu-content">
            <h1 class="menu-title">Б Р О Н Е Т А Н К.И.</h1>
            <button class="mode-btn active" id="btn-pvp">ИГРОК VS ИГРОК</button>
            <button class="mode-btn" id="btn-pve">ИГРОК VS БОТ</button>
            <div style="color: #ffeb3b; font-weight: bold; margin-bottom: 20px;">ДЛЯ НИКИТЫ</div>
            <button class="start-btn" id="start-game">В БОЙ!</button>
        </div>
    </div>
    <button id="exit-to-menu" class="back-to-menu-btn">ВЫХОД</button>
    <div id="score2" class="score">0</div>
    <div id="score1" class="score">0</div>
    <canvas id="gameCanvas"></canvas>
    <div class="controls-layer" id="p1-controls" style="display: none;"><div id="p1-joy" class="joy-zone"><div class="stick"></div></div><div id="p1-fire" class="btn-fire">ОГОНЬ</div></div>
    <div class="controls-layer" id="p2-controls" style="display: none;"><div id="p2-joy" class="joy-zone"><div class="stick"></div></div><div id="p2-fire" class="btn-fire">ОГОНЬ</div></div>

<script>
// --- CONFIG & STATE ---
const CONFIG = { TANK: { SPEED: 3.5, HP: 3, COOLDOWN: 280 }, BULLET: { SPEED: 14 } };
let tanks = [], bullets = [], bricks = [], explosions = [], sosSquad = [], isGameActive = false, gameMode = 'pvp';
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const bgCanvas = document.getElementById('menu-bg');
const bgCtx = bgCanvas.getContext('2d');

// --- AUDIO ---
const AudioEngine = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    playMarch() {
        if(!this.ctx) return;
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.type = 'square'; o.frequency.setValueAtTime(50, this.ctx.currentTime);
        g.gain.setValueAtTime(0.1, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.1);
        o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime + 0.1);
    }
};

// --- MENU BG ---
let bgObjects = { tanks: [], planes: [] };
function initMenuBg() {
    bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
    bgObjects.tanks = Array(6).fill(0).map(() => ({
        x: Math.random()*bgCanvas.width, y: bgCanvas.height*0.5 + Math.random()*bgCanvas.height*0.4, 
        s: 1.5 + Math.random()*2, color: '#4caf50'
    }));
}
function drawMenuBg() {
    bgCtx.fillStyle = '#050505'; bgCtx.fillRect(0,0,bgCanvas.width, bgCanvas.height);
    bgObjects.tanks.forEach(t => {
        t.x += t.s; if(t.x > bgCanvas.width + 100) t.x = -100;
        bgCtx.fillStyle = t.color; bgCtx.fillRect(t.x, t.y, 60, 25);
        bgCtx.fillStyle = '#000'; bgCtx.fillRect(t.x, t.y+20, 60, 5);
    });
    if(!isGameActive) requestAnimationFrame(drawMenuBg);
}

// --- GAME OBJECTS ---
class Tank {
    constructor(id, color, isBottom, isAI = false) {
        this.id = id; this.color = color; this.isBottom = isBottom; this.isAI = isAI;
        this.score = 0; this.sosBuffer = []; this.reset();
    }
    reset() {
        this.x = canvas.width / 2; this.y = this.isBottom ? canvas.height - 80 : 80;
        this.angle = this.isBottom ? -Math.PI/2 : Math.PI/2;
        this.hp = CONFIG.TANK.HP; this.dx = 0; this.dy = 0; this.lastShot = 0;
        this.isExploding = false; this.explosionTimer = 0; this.flash = 0; this.isSOS = false;
    }
}

function createBricks() {
    bricks = []; const cx = canvas.width / 2;
    const addW = (x, y, w, h) => { for(let i=0; i<w; i++) for(let j=0; j<h; j++) bricks.push({x: x+i*26, y: y+j*16, w: 25, h: 15}); };
    addW(cx-78, 105, 6, 2); addW(cx-78, 73, 1, 2); addW(cx+52, 73, 1, 2); // Top
    addW(cx-78, canvas.height-150, 6, 2); addW(cx-78, canvas.height-118, 1, 2); addW(cx+52, canvas.height-118, 1, 2); // Bot
}

function shoot(t) {
    if (t.isExploding || Date.now() - t.lastShot < CONFIG.TANK.COOLDOWN) return;
    bullets.push({ x: t.x+Math.cos(t.angle)*45, y: t.y+Math.sin(t.angle)*45, angle: t.angle, ownerId: t.id, isSOS: t.isSOS });
    t.flash = 6; t.lastShot = Date.now();
}

function drawTank(t) {
    ctx.save(); ctx.translate(t.x, t.y); ctx.rotate(t.angle);
    if(t.isExploding) ctx.globalAlpha = Math.random();
    ctx.fillStyle = '#444'; [-20, 10].forEach(y => ctx.fillRect(-24, y, 48, 10)); // Tracks
    ctx.fillStyle = t.color; ctx.strokeStyle = '#000'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.roundRect(-22, -16, 44, 32, 4); ctx.fill(); ctx.stroke(); // Hull
    ctx.beginPath(); ctx.arc(-2, 0, 14, 0, Math.PI*2); ctx.fill(); ctx.stroke(); // Turret
    ctx.fillStyle = '#111'; ctx.fillRect(10, -3, 28, 6); ctx.fillRect(35, -5, 8, 10); // Cannon
    if(t.flash > 0) {
        ctx.fillStyle = 'rgba(255,255,200,0.8)'; ctx.beginPath(); ctx.arc(45,0,20,0,Math.PI*2); ctx.fill(); t.flash--;
    }
    ctx.restore();
}

function update() {
    if (!isGameActive) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    bricks.forEach(b => { ctx.fillStyle = '#8d4925'; ctx.fillRect(b.x, b.y, b.w, b.h); ctx.strokeRect(b.x, b.y, b.w, b.h); });

    tanks.concat(sosSquad).forEach(t => {
        if(t.isExploding) { t.explosionTimer++; if(t.explosionTimer > 60) t.reset(); }
        else {
            if(t.isAI || t.isSOS) {
                let target = tanks[t.id===0?1:0]; let a = Math.atan2(target.y-t.y, target.x-t.x); t.angle = a;
                if(Math.hypot(target.x-t.x, target.y-t.y)>200){ t.dx=Math.cos(a); t.dy=Math.sin(a); } else { t.dx=0; t.dy=0; if(Math.random()<0.03) shoot(t); }
            }
            let nx = t.x + t.dx*CONFIG.TANK.SPEED, ny = t.y + t.dy*CONFIG.TANK.SPEED;
            if(!checkCol(nx, t.y, 22)) t.x = nx; if(!checkCol(t.x, ny, 22)) t.y = ny;
        }
        drawTank(t);
    });

    bullets.forEach((b, bi) => {
        b.x += Math.cos(b.angle)*CONFIG.BULLET.SPEED; b.y += Math.sin(b.angle)*CONFIG.BULLET.SPEED;
        ctx.fillStyle = '#ffeb3b'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill();
        let hitT = tanks.find(t => !t.isExploding && b.ownerId !== t.id && Math.hypot(b.x-t.x, b.y-t.y) < 25);
        let col = checkCol(b.x, b.y, 5);
        if(hitT) {
            hitT.hp--; explosions.push({x: b.x, y: b.y, life: 8, r: 25, a: 0.6});
            if(hitT.hp <= 0) { hitT.isExploding = true; if(!b.isSOS) tanks[b.ownerId].score++; }
            bullets.splice(bi, 1);
        } else if(col) {
            explosions.push({x: b.x, y: b.y, life: 6, r: 22, a: 0.7});
            bullets.splice(bi, 1);
        }
    });

    explosions.forEach((e, i) => {
        ctx.save(); ctx.fillStyle = `rgba(255,100,0,${e.a})`; ctx.beginPath();
        ctx.ellipse(e.x, e.y, e.r*1.6, e.r*0.6, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();
        e.life--; if(e.life <= 0) explosions.splice(i, 1);
    });
    
    document.getElementById('score1').innerText = tanks[0].score;
    document.getElementById('score2').innerText = tanks[1].score;
    requestAnimationFrame(update);
}

function checkCol(x, y, r) {
    if (x < r || x > canvas.width - r || y < r || y > canvas.height - r) return true;
    for (let b of bricks) if (x+r > b.x && x-r < b.x+b.w && y+r > b.y && y-r < b.y+b.h) return true;
    return false;
}

// --- УПРАВЛЕНИЕ (FIXED) ---
const touchData = new Map();
const setupControls = () => {
    const handleTouch = (e) => {
        if(!isGameActive) return; e.preventDefault();
        for(let t of e.changedTouches) {
            const joy = [document.getElementById('p1-joy'), document.getElementById('p2-joy')].find(el => {
                let r = el.getBoundingClientRect(); return t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom;
            });
            const fire = [document.getElementById('p1-fire'), document.getElementById('p2-fire')].find(el => {
                let r = el.getBoundingClientRect(); return t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom;
            });

            if(joy) {
                const idx = joy.id === 'p1-joy' ? 0 : 1;
                touchData.set(t.identifier, {type: 'joy', idx, el: joy});
            } else if(fire) {
                const idx = fire.id === 'p1-fire' ? 0 : 1;
                shoot(tanks[idx]);
                touchData.set(t.identifier, {type: 'fire', idx, start: Date.now()});
            }
        }
    };

    window.addEventListener('touchstart', (e) => { AudioEngine.init(); handleTouch(e); }, {passive: false});
    window.addEventListener('touchmove', (e) => {
        if(!isGameActive) return; e.preventDefault();
        for(let t of e.changedTouches) {
            let data = touchData.get(t.identifier);
            if(data && data.type === 'joy') {
                let r = data.el.getBoundingClientRect();
                let dx = (t.clientX - (r.left + 80))/80, dy = (t.clientY - (r.top + 80))/80;
                let d = Math.min(1, Math.hypot(dx, dy)), a = Math.atan2(dy, dx);
                tanks[data.idx].dx = Math.cos(a)*d; tanks[data.idx].dy = Math.sin(a)*d; tanks[data.idx].angle = a;
                data.el.querySelector('.stick').style.transform = `translate(${Math.cos(a)*d*45}px,${Math.sin(a)*d*45}px)`;
            }
        }
    }, {passive: false});

    window.addEventListener('touchend', (e) => {
        for(let t of e.changedTouches) {
            let data = touchData.get(t.identifier);
            if(data) {
                if(data.type === 'joy') { tanks[data.idx].dx = 0; tanks[data.idx].dy = 0; data.el.querySelector('.stick').style.transform = 'none'; }
                if(data.type === 'fire') {
                    let dur = Date.now() - data.start; let tk = tanks[data.idx];
                    tk.sosBuffer.push(dur > 220 ? '-' : '.'); if(tk.sosBuffer.length > 9) tk.sosBuffer.shift();
                    if(tk.sosBuffer.join('').includes('...---...')) { triggerSOS(data.idx); tk.sosBuffer = []; }
                }
                touchData.delete(t.identifier);
            }
        }
    });
};

function triggerSOS(idx) {
    const owner = tanks[idx];
    for(let i=0; i<5; i++) {
        let s = new Tank(idx, owner.color, false, true);
        s.x = Math.random()*canvas.width; s.y = owner.isBottom ? canvas.height+100 : -100;
        s.isSOS = true; sosSquad.push(s);
    }
}

// --- MENU LOGIC ---
document.getElementById('start-game').onclick = () => {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    tanks = [new Tank(0, '#2e7d32', true), new Tank(1, '#c62828', false, gameMode === 'pve')];
    createBricks(); isGameActive = true;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('p1-controls').style.display = 'block';
    document.getElementById('p2-controls').style.display = (gameMode === 'pve' ? 'none' : 'block');
    document.getElementById('exit-to-menu').style.display = 'block'; update();
};
document.getElementById('btn-pvp').onclick = () => { gameMode = 'pvp'; document.getElementById('btn-pvp').className = 'mode-btn active'; document.getElementById('btn-pve').className = 'mode-btn'; };
document.getElementById('btn-pve').onclick = () => { gameMode = 'pve'; document.getElementById('btn-pve').className = 'mode-btn active'; document.getElementById('btn-pvp').className = 'mode-btn'; };
document.getElementById('exit-to-menu').onclick = () => location.reload();

initMenuBg(); drawMenuBg(); setupControls();
</script>
</body>
</html>
