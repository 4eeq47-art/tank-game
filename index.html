<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>БРОНЕТАНКИ: ПЕРЕЗАГРУЗКА</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #222; overflow: hidden; touch-action: none; font-family: 'Courier New', monospace; }
        canvas { display: block; position: absolute; inset: 0; }
        #bgCanvas { z-index: 1; }
        #gameCanvas { z-index: 5; display: none; background: #444; }
        
        #menu { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .m-card { background: #eee; padding: 40px; border: 5px solid #333; border-radius: 10px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .btn { pointer-events: auto; width: 280px; padding: 18px; margin: 10px; font-size: 22px; font-weight: 900; color: #fff; background: #444; border: 3px solid #000; cursor: pointer; }
        .btn.active { background: #2e7d32; border-color: #aeea00; }
        .start { background: #b71c1c; font-size: 32px; height: 90px; }
        
        #ui { position: fixed; inset: 0; z-index: 10; pointer-events: none; display: none; }
        .score { position: absolute; width: 100%; text-align: center; font-size: 45px; font-weight: 900; text-shadow: 2px 2px 0 #000; }
        #score2 { top: 110px; transform: rotate(180deg); color: #ff5252; }
        #score1 { bottom: 135px; color: #69f0ae; }
        
        .ctrl { position: absolute; pointer-events: auto; border-radius: 50%; border: 4px solid rgba(0,0,0,0.3); }
        .joy { width: 170px; height: 170px; background: rgba(255,255,255,0.2); }
        .fire { width: 130px; height: 130px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #fff; text-shadow: 1px 1px 0 #000; }
        .stick { position: absolute; width: 70px; height: 70px; border-radius: 50%; top: 46px; left: 46px; pointer-events: none; }
        
        #exit-btn { position: fixed; right: 10px; top: 50%; transform: translateY(-50%) rotate(90deg); z-index: 200; padding: 15px 30px; background: #333; color: #fff; border: 3px solid #fff; font-weight: 900; display: none; cursor: pointer; pointer-events: auto; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<canvas id="gameCanvas"></canvas>

<div id="menu">
    <div class="m-card">
        <h1 style="color: #333; font-size: 50px; margin: 0 0 20px 0;">БРОНЕТАНКИ</h1>
        <button class="btn active" id="pvp-btn">ИГРОК VS ИГРОК</button>
        <button class="btn" id="pve-btn">ИГРОК VS БОТ</button>
        <button class="btn start" id="start-btn">В БОЙ!</button>
    </div>
</div>

<div id="ui">
    <div id="score2" class="score">0</div>
    <div id="score1" class="score">0</div>
    <div id="p1-joy" class="ctrl joy" style="left:40px; bottom:40px;"><div class="stick" style="background: #2e7d32; border: 3px solid #1b5e20;"></div></div>
    <div id="p1-fire" class="ctrl fire" style="right:40px; bottom:40px; background: rgba(46,125,50,0.6);">ОГОНЬ</div>
    <div id="p2-joy" class="ctrl joy" style="right:40px; top:40px;"><div class="stick" style="background: #c62828; border: 3px solid #b71c1c;"></div></div>
    <div id="p2-fire" class="ctrl fire" style="left:40px; top:40px; transform: rotate(180deg); background: rgba(198,40,40,0.6);">ОГОНЬ</div>
</div>

<button id="exit-btn">В МЕНЮ</button>

<script>
const bgCvs = document.getElementById('bgCanvas'), gCvs = document.getElementById('gameCanvas');
const bctx = bgCvs.getContext('2d'), gctx = gCvs.getContext('2d');
let W, H, isGame = false, gameMode = 'pvp', audioCtx = null;
let tanks = [], bullets = [], bricks = [], explosions = [];

// --- SOUND ENGINE ---
function playSound(freq, type, dur, vol, slide) {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    if(slide) osc.frequency.exponentialRampToValueAtTime(slide, audioCtx.currentTime + dur);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
}

function startMusic() {
    setInterval(() => {
        if(!isGame) {
            const notes = [220, 220, 220, 293, 329, 349];
            playSound(notes[Math.floor(Date.now()/500)%6], 'square', 0.4, 0.05);
        }
    }, 500);
}

// --- TANK CLASS ---
class Tank {
    constructor(id, color, isBot, isBottom) {
        this.id = id; this.color = color; this.isBot = isBot; this.isBottom = isBottom;
        this.score = 0; this.reset();
    }
    reset() {
        this.x = W/2; this.y = this.isBottom ? H-120 : 120;
        this.angle = this.isBottom ? -Math.PI/2 : Math.PI/2;
        this.hp = 3; this.dx = 0; this.dy = 0; this.flash = 0; this.dead = false; this.deadT = 0;
        this.lastS = 0; this.reversing = 0;
    }
}

function drawTank(ctx, t) {
    ctx.save(); ctx.translate(t.x, t.y);
    // HP Bar
    ctx.fillStyle = '#000'; ctx.fillRect(35, -20, 6, 40);
    ctx.fillStyle = t.id === 0 ? '#69f0ae' : '#ff5252';
    ctx.fillRect(35, -20 + (40*(1-t.hp/3)), 6, 40*(t.hp/3));

    ctx.rotate(t.angle);
    if(t.dead) ctx.globalAlpha = 0.2;
    // Classic Tracks
    ctx.fillStyle = '#222'; ctx.fillRect(-26, -20, 52, 10); ctx.fillRect(-26, 10, 52, 10);
    for(let i=-22; i<24; i+=8) { ctx.fillStyle='#111'; ctx.fillRect(i,-20,2,10); ctx.fillRect(i,10,2,10); }
    // Hull
    ctx.fillStyle = t.color; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.roundRect(-22, -16, 44, 32, 3); ctx.fill(); ctx.stroke();
    // Turret
    ctx.beginPath(); ctx.arc(-2, 0, 14, 0, 7); ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#111'; ctx.fillRect(12, -4, 30, 8); // Barrel
    ctx.fillStyle = t.color; ctx.fillRect(38, -8, 10, 16); ctx.strokeRect(38,-8,10,16); // Brake

    if(t.flash > 0) {
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(55, 0, 25, 0, 7); ctx.fill();
        t.flash--;
    }
    ctx.restore();
}

// --- AI BRAIN ---
function updateAI(t) {
    const tar = tanks[0];
    if (t.reversing > 0) {
        t.dx = -Math.cos(t.angle); t.dy = -Math.sin(t.angle); t.angle += 0.05; t.reversing--;
        return;
    }
    const nextX = t.x + Math.cos(t.angle)*30, nextY = t.y + Math.sin(t.angle)*30;
    if(colCheck(nextX, nextY, 20)) { t.reversing = 40; } 
    else {
        t.angle = Math.atan2(tar.y - t.y, tar.x - t.x);
        t.dx = Math.cos(t.angle); t.dy = Math.sin(t.angle);
        if(Math.random() < 0.03) shoot(t);
    }
}

// --- MAIN LOOP ---
let mTime = 0;
function loop() {
    W = window.innerWidth; H = window.innerHeight;
    bgCvs.width = gCvs.width = W; bgCvs.height = gCvs.height = H;

    if(!isGame) {
        bctx.fillStyle = '#ddd'; bctx.fillRect(0,0,W,H);
        mTime += 0.01;
        // Planes & Bombs
        for(let i=0; i<2; i++) {
            let px = (mTime*200 + i*500) % (W+400) - 200;
            bctx.fillStyle = '#666'; bctx.fillRect(px, 100+i*100, 60, 15); // Plane
            if(Math.floor(px)%300 === 0) { 
                playSound(800, 'sine', 1.5, 0.1, 100); // Whistle
                explosions.push({x: px, y: H*0.8, l: 20}); 
            }
        }
    } else {
        gctx.fillStyle = '#666'; gctx.fillRect(0,0,W,H); // Gray Background
        gctx.strokeStyle = '#555'; for(let i=0; i<W; i+=50) { gctx.beginPath(); gctx.moveTo(i,0); gctx.lineTo(i,H); gctx.stroke(); }
        
        bricks.forEach(b => { gctx.fillStyle = '#8d4925'; gctx.fillRect(b.x, b.y, 25, 15); gctx.strokeRect(b.x, b.y, 25, 15); });

        tanks.forEach(t => {
            if(t.dead) { t.deadT++; if(t.deadT > 100) t.reset(); }
            else {
                if(t.isBot) updateAI(t);
                let nx = t.x + t.dx*3.5, ny = t.y + t.dy*3.5;
                if(!colCheck(nx, t.y, 22)) t.x = nx; if(!colCheck(t.x, ny, 22)) t.y = ny;
            }
            drawTank(gctx, t);
        });

        bullets.forEach((b, i) => {
            b.x += Math.cos(b.a)*15; b.y += Math.sin(b.a)*15;
            gctx.fillStyle = '#fff'; gctx.beginPath(); gctx.arc(b.x, b.y, 5, 0, 7); gctx.fill();
            let hit = tanks.find(tk => !tk.dead && b.owner !== tk.id && Math.hypot(b.x-tk.x, b.y-tk.y) < 25);
            if(hit) { hit.hp--; explosions.push({x:b.x, y:b.y, l:15}); if(hit.hp<=0){ hit.dead=true; tanks[b.owner].score++; } bullets.splice(i,1); }
            else if(colCheck(b.x, b.y, 5)) { explosions.push({x:b.x, y:b.y, l:10}); bullets.splice(i,1); }
        });

        explosions.forEach((e, i) => {
            gctx.fillStyle = `rgba(255,255,255,${e.l/15})`; gctx.beginPath(); gctx.arc(e.x, e.y, 30-e.l, 0, 7); gctx.fill();
            e.l--; if(e.l<=0) explosions.splice(i,1);
        });
        document.getElementById('score1').innerText = tanks[0].score;
        document.getElementById('score2').innerText = tanks[1].score;
    }
    requestAnimationFrame(loop);
}

function shoot(t) {
    if(t.dead || Date.now() - t.lastS < 300) return;
    bullets.push({x: t.x + Math.cos(t.angle)*45, y: t.y + Math.sin(t.angle)*45, a: t.angle, owner: t.id});
    t.flash = 5; t.lastS = Date.now();
    playSound(150, 'sawtooth', 0.1, 0.1);
}

function colCheck(x, y, r) {
    if(x<r || x>W-r || y<r || y>H-r) return true;
    return bricks.some(b => x+r > b.x && x-r < b.x+25 && y+r > b.y && y-r < b.y+15);
}

// --- INPUT HANDLING ---
const activePointers = {};
function setupInput() {
    const handle = (e) => {
        if(!isGame) return;
        for(let t of e.changedTouches) {
            const x = t.clientX, y = t.clientY;
            if(e.type === 'touchstart' || e.type === 'touchmove') {
                ['p1-joy','p2-joy'].forEach((id, i) => {
                    const r = document.getElementById(id).getBoundingClientRect();
                    const cx = r.left + 85, cy = r.top + 85;
                    if(Math.hypot(x-cx, y-cy) < 180) { // Large capture area
                        let dx = (x-cx)/85, dy = (y-cy)/85;
                        let a = Math.atan2(dy, dx), d = Math.min(1, Math.hypot(dx, dy));
                        tanks[i].dx = Math.cos(a)*d; tanks[i].dy = Math.sin(a)*d; tanks[i].angle = a;
                        document.getElementById(id).querySelector('.stick').style.transform = `translate(${dx*40}px, ${dy*40}px)`;
                        activePointers[t.identifier] = i;
                    }
                });
                ['p1-fire','p2-fire'].forEach((id, i) => {
                    const r = document.getElementById(id).getBoundingClientRect();
                    if(x>r.left && x<r.right && y>r.top && y<r.bottom && e.type==='touchstart') shoot(tanks[i]);
                });
            }
            if(e.type === 'touchend') {
                let id = activePointers[t.identifier];
                if(id !== undefined) {
                    tanks[id].dx = 0; tanks[id].dy = 0;
                    document.querySelectorAll('.stick')[id].style.transform = 'none';
                }
                delete activePointers[t.identifier];
            }
        }
    };
    ['touchstart','touchmove','touchend'].forEach(n => window.addEventListener(n, handle, {passive:false}));
}

document.getElementById('start-btn').onclick = () => {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    startMusic();
    isGame = true; gCvs.style.display = 'block';
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('exit-btn').style.display = 'block';
    tanks = [new Tank(0, '#2e7d32', false, true), new Tank(1, '#c62828', gameMode==='pve', false)];
    if(gameMode==='pve') { document.getElementById('p2-joy').style.display='none'; document.getElementById('p2-fire').style.display='none'; }
    
    bricks = []; let cx = W/2 - 75;
    const r = (x,y,w,h) => { for(let i=0; i<w; i++) for(let j=0; j<h; j++) bricks.push({x:x+i*26, y:y+j*16}); };
    // Correct P-Shapes
    r(cx, 100, 6, 1); r(cx, 116, 1, 4); r(cx+130, 116, 1, 4); // Upper (Facing Down)
    r(cx, H-116, 6, 1); r(cx, H-180, 1, 4); r(cx+130, H-180, 1, 4); // Lower (Facing Up)
};

document.getElementById('pvp-btn').onclick = () => { gameMode='pvp'; document.getElementById('pvp-btn').className='btn active'; document.getElementById('pve-btn').className='btn'; };
document.getElementById('pve-btn').onclick = () => { gameMode='pve'; document.getElementById('pve-btn').className='btn active'; document.getElementById('pvp-btn').className='btn'; };
document.getElementById('exit-btn').onclick = () => location.href = location.href;

loop(); setupInput();
</script>
</body>
</html>
