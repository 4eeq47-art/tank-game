<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tanks POV Setup</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: sans-serif; -webkit-user-select: none; }
        canvas { display: block; }
        
        #setup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 500; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; gap: 15px;
        }
        .setup-row { display: flex; width: 100%; justify-content: space-around; align-items: center; flex: 1; }
        .player-box { padding: 15px; border-radius: 15px; background: rgba(255,255,255,0.05); width: 42%; text-align: center; border: 2px solid #333; }
        .p1-box { border-color: #0f0; }
        /* Красный блок развернут, чтобы "СЛЕВА" для него было физически справа для нас */
        .p2-box { border-color: #f00; transform: rotate(180deg); }
        
        .control-group { margin: 8px 0; }
        .btn-toggle {
            padding: 10px 18px; margin: 3px; font-size: 13px; cursor: pointer;
            background: #222; color: #aaa; border: 1px solid #444; border-radius: 6px;
        }
        .p1-box .active { background: #060; color: #fff; border-color: #0f0; box-shadow: 0 0 10px #060; }
        .p2-box .active { background: #600; color: #fff; border-color: #f00; box-shadow: 0 0 10px #600; }

        #map-preview {
            width: 260px; height: 140px; border: 2px solid #444; position: relative;
            background: #050505; border-radius: 10px;
        }
        .base-p { position: absolute; width: 40px; height: 25px; border-radius: 4px; font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        #b-green { bottom: 10px; left: 110px; background: #0f0; color: #000; }
        #b-red { top: 10px; left: 110px; background: #f00; color: #fff; }
        
        /* Точки-индикаторы на мини-карте */
        .dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; opacity: 0; transition: 0.3s; }
        .dot.active { opacity: 1; }

        #start-btn {
            padding: 18px 50px; font-size: 20px; background: #fff; color: #000;
            border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
        }

        .score { position: absolute; width: 100%; text-align: center; font-size: 24px; font-weight: bold; z-index: 100; pointer-events: none; }
        #s1 { bottom: 20px; color: #0f0; }
        #s2 { top: 20px; color: #f00; transform: rotate(180deg); }
        
        .joy-zone, .btn-fire { position: fixed; border-radius: 50%; z-index: 200; touch-action: none; border: none; visibility: hidden; }
        .joy-zone { width: 120px; height: 120px; background: rgba(255,255,255,0.08); }
        .stick { position: absolute; width: 50px; height: 50px; border-radius: 50%; top: 35px; left: 35px; pointer-events: none; }
        .btn-fire { width: 110px; height: 110px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; }
        .btn-fire span { transform: rotate(180deg); display: inline-block; }
        
        #p1-stick { background: #0f0; box-shadow: 0 0 15px #0f0; }
        #p2-stick { background: #f00; box-shadow: 0 0 15px #f00; }
        #p1-fire { background: rgba(0,255,0,0.3); color: #0f0; }
        #p2-fire { background: rgba(255,0,0,0.3); color: #f00; transform: rotate(180deg); }
    </style>
</head>
<body>

    <div id="setup-overlay">
        <div class="setup-row">
            <div class="player-box p2-box">
                <b>КРАСНЫЙ (ВЕРХ)</b>
                <div class="control-group">
                    <label>ДЖОЙСТИК</label>
                    <button class="btn-toggle active" onclick="setCfg(1,'j','L',event)">СЛЕВА</button>
                    <button class="btn-toggle" onclick="setCfg(1,'j','R',event)">СПРАВА</button>
                </div>
                <div class="control-group">
                    <label>ОГОНЬ</label>
                    <button class="btn-toggle" onclick="setCfg(1,'f','R',event)">СПРАВА</button>
                    <button class="btn-toggle active" onclick="setCfg(1,'f','L',event)">СЛЕВА</button>
                </div>
            </div>
        </div>

        <div id="map-preview">
            <div id="b-red" class="base-p">БАЗА</div>
            <div id="dot-2-joy" class="dot active" style="top:5px; right:5px; background:#f00;"></div>
            <div id="dot-2-fire" class="dot active" style="top:5px; left:5px; background:#f00; border:1px solid white;"></div>
            
            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#222; font-weight:bold; letter-spacing:5px;">TANKS</div>
            
            <div id="b-green" class="base-p">БАЗА</div>
            <div id="dot-1-joy" class="dot active" style="bottom:5px; left:5px; background:#0f0;"></div>
            <div id="dot-1-fire" class="dot active" style="bottom:5px; right:5px; background:#0f0; border:1px solid white;"></div>
        </div>
        
        <button id="start-btn" onclick="startGame()">НАЧАТЬ БОЙ</button>

        <div class="setup-row">
            <div class="player-box p1-box">
                <b>ЗЕЛЕНЫЙ (НИЗ)</b>
                <div class="control-group">
                    <label>ДЖОЙСТИК</label>
                    <button class="btn-toggle active" onclick="setCfg(0,'j','L',event)">СЛЕВА</button>
                    <button class="btn-toggle" onclick="setCfg(0,'j','R',event)">СПРАВА</button>
                </div>
                <div class="control-group">
                    <label>ОГОНЬ</label>
                    <button class="btn-toggle" onclick="setCfg(0,'f','L',event)">СЛЕВА</button>
                    <button class="btn-toggle active" onclick="setCfg(0,'f','R',event)">СПРАВА</button>
                </div>
            </div>
        </div>
    </div>

    <div id="s2" class="score">Красный: 0</div>
    <div id="s1" class="score">Зеленый: 0</div>
    <canvas id="g"></canvas>
    
    <div id="p1-fire" class="btn-fire"><span>ОГОНЬ</span></div>
    <div id="p1-joy" class="joy-zone"><div id="p1-stick" class="stick"></div></div>
    <div id="p2-fire" class="btn-fire"><span>ОГОНЬ</span></div>
    <div id="p2-joy" class="joy-zone"><div id="p2-stick" class="stick"></div></div>

<script>
const cvs = document.getElementById('g'); const ctx = cvs.getContext('2d');
let gameStarted = false;
let cfg = [ {j:'L', f:'R'}, {j:'L', f:'L'} ]; // Дефолтные настройки

function setCfg(p, type, side, e) {
    cfg[p][type] = side;
    const parent = e.target.parentElement;
    parent.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    updateDots();
}

function updateDots() {
    // Зеленый: L=L, R=R
    document.getElementById('dot-1-joy').style.left = cfg[0].j === 'L' ? '5px' : 'auto';
    document.getElementById('dot-1-joy').style.right = cfg[0].j === 'R' ? '5px' : 'auto';
    document.getElementById('dot-1-fire').style.left = cfg[0].f === 'L' ? '5px' : 'auto';
    document.getElementById('dot-1-fire').style.right = cfg[0].f === 'R' ? '5px' : 'auto';

    // Красный: С точки зрения сидящего сверху L — это физически ПРАВО
    document.getElementById('dot-2-joy').style.right = cfg[1].j === 'L' ? '5px' : 'auto';
    document.getElementById('dot-2-joy').style.left = cfg[1].j === 'R' ? '5px' : 'auto';
    document.getElementById('dot-2-fire').style.right = cfg[1].f === 'L' ? '5px' : 'auto';
    document.getElementById('dot-2-fire').style.left = cfg[1].f === 'R' ? '5px' : 'auto';
}

function startGame() {
    applyLayout();
    document.getElementById('setup-overlay').style.display = 'none';
    document.querySelectorAll('.joy-zone, .btn-fire').forEach(el => el.style.visibility = 'visible');
    gameStarted = true;
    resize();
}

function applyLayout() {
    const p1j = document.getElementById('p1-joy'), p1f = document.getElementById('p1-fire');
    const p2j = document.getElementById('p2-joy'), p2f = document.getElementById('p2-fire');
    
    // Зеленый (Нижний)
    p1j.style.left = cfg[0].j === 'L' ? '30px' : 'auto'; p1j.style.right = cfg[0].j === 'R' ? '30px' : 'auto';
    p1f.style.left = cfg[0].f === 'L' ? '30px' : 'auto'; p1f.style.right = cfg[0].f === 'R' ? '30px' : 'auto';
    
    // Красный (Верхний): Для него СЛЕВА — это физически ПРАВО на планшете
    p2j.style.right = cfg[1].j === 'L' ? '30px' : 'auto'; p2j.style.left = cfg[1].j === 'R' ? '30px' : 'auto';
    p2f.style.right = cfg[1].f === 'L' ? '30px' : 'auto'; p2f.style.left = cfg[1].f === 'R' ? '30px' : 'auto';

    [p1j, p1f].forEach(el => el.style.bottom = '30px');
    [p2j, p2f].forEach(el => el.style.top = '30px');
}

// ... (Остальной код механики танков, пуль и пасхалки остается из предыдущей версии) ...
function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();
let bullets = [], explosions = [], surrenderAnims = [];
let deathCounts = { 0: 0, 1: 0 };
const gap = 100;
let tanks = [{x:gap,y:0,c:'green',a:0,s:0,hp:3,dx:0,dy:0,id:0,dead:false},{x:0,y:0,c:'red',a:Math.PI,s:0,hp:3,dx:0,dy:0,id:1,dead:false}];
tanks[0].y = cvs.height/2; tanks[1].x = cvs.width-gap; tanks[1].y = cvs.height/2;

function drawHuman(a) {
    let age = Date.now()-a.t; let wave = Math.sin(age/120)*4;
    ctx.save(); ctx.translate(a.x,a.y); if(a.id===1) ctx.rotate(Math.PI);
    ctx.strokeStyle="white"; ctx.fillStyle="white"; ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(-4,8);ctx.lineTo(0,0);ctx.lineTo(4,8);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,-12);ctx.stroke();
    ctx.beginPath();ctx.arc(0,-16,4,0,7);ctx.fill();
    ctx.beginPath();ctx.moveTo(-6,-8);ctx.lineTo(6,-8);ctx.stroke();
    ctx.beginPath();ctx.moveTo(6,-8);ctx.lineTo(12,-30+wave);ctx.stroke();
    ctx.fillRect(12,-30+wave,18,12); ctx.restore();
}

function drawTank(t) {
    ctx.save(); ctx.translate(t.x, t.y); ctx.rotate(t.a);
    ctx.fillStyle = t.dead ? '#1a1a1a' : t.c; 
    ctx.beginPath(); ctx.roundRect(-24,-20,48,40,12); ctx.fill();
    ctx.fillStyle='rgba(0,0,0,0.5)';ctx.beginPath();ctx.arc(0,0,12,0,7);ctx.fill();
    ctx.fillStyle=t.dead?'#000':'#888';ctx.fillRect(15,-5,25,10);ctx.restore();
    if(!t.dead){ctx.fillStyle="#333";ctx.fillRect(t.x-23,t.y-45,46,6);ctx.fillStyle=t.id===0?'#0f0':'#f00';ctx.fillRect(t.x-23,t.y-45,(t.hp/3)*46,6);}
}

function update() {
    if(!gameStarted) { requestAnimationFrame(update); return; }
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,cvs.width,cvs.height);
    const walls = [{x:gap-20,y:cvs.height/2-80,w:100,h:10},{x:gap-20,y:cvs.height/2+70,w:100,h:10},{x:gap+80,y:cvs.height/2-80,w:10,h:160},{x:cvs.width-gap-80,y:cvs.height/2-80,w:100,h:10},{x:cvs.width-gap-80,y:cvs.height/2+70,w:100,h:10},{x:cvs.width-gap-90,y:cvs.height/2-80,w:10,h:160}];
    ctx.fillStyle='#222'; walls.forEach(w=>ctx.fillRect(w.x,w.y,w.w,w.h));
    surrenderAnims=surrenderAnims.filter(a=>{drawHuman(a);if(Date.now()-a.t>=3000){tanks[a.id].dead=false;tanks[a.id].hp=3;tanks[a.id].x=a.id===0?gap:cvs.width-gap;tanks[a.id].y=cvs.height/2;return false;}return true;});
    explosions.forEach((ex,i)=>{ctx.beginPath();ctx.arc(ex.x,ex.y,ex.r,0,7);ctx.fillStyle=`rgba(255,100,0,${ex.a})`;ctx.fill();ex.r+=3;ex.a-=0.05;if(ex.a<=0)explosions.splice(i,1);});
    tanks.forEach(t=>{
        if(!t.dead&&(Math.abs(t.dx)>0.05||Math.abs(t.dy)>0.05)){
            let nX=t.x+t.dx*3.8; let nY=t.y+t.dy*3.8;
            if(!walls.some(w=>nX+22>w.x&&nX-22<w.x+w.w&&nY+22>w.y&&nY-22<w.y+w.h)){t.x=nX;t.y=nY;}
            t.a=Math.atan2(t.dy,t.dx);
        }
        t.x=Math.max(25,Math.min(cvs.width-25,t.x));t.y=Math.max(25,Math.min(cvs.height-25,t.y));
        drawTank(t);
    });
    for(let i=bullets.length-1;i>=0;i--){
        let b=bullets[i];b.x+=Math.cos(b.a)*12;b.y+=Math.sin(b.a)*12;
        ctx.fillStyle='yellow';ctx.beginPath();ctx.arc(b.x,b.y,4,0,7);ctx.fill();
        let hit=false; if(walls.some(w=>b.x>w.x&&b.x<w.x+w.w&&b.y>w.y&&b.y<w.y+w.h))hit=true;
        tanks.forEach(t=>{
            if(!t.dead&&b.owner!==t.id&&Math.hypot(b.x-t.x,b.y-t.y)<28){
                t.hp--; hit=true;
                if(t.hp<=0){
                    explosions.push({x:t.x,y:t.y,r:35,a:1});deathCounts[t.id]++;tanks[b.owner].s++;
                    document.getElementById('s'+(b.owner+1)).innerText=(b.owner===0?'Зеленый: ':'Красный: ')+tanks[b.owner].s;
                    if(deathCounts[t.id]%10===0){t.dead=true;surrenderAnims.push({x:t.x,y:t.y,id:t.id,t:Date.now()});}
                    else{t.x=t.id===0?gap:cvs.width-gap;t.y=cvs.height/2;t.hp=3;}
                }else explosions.push({x:b.x,y:b.y,r:7,a:1});
            }
        });
        if(hit||b.x<0||b.x>cvs.width||b.y<0||b.y>cvs.height)bullets.splice(i,1);
    }
    requestAnimationFrame(update);
}

function setupJoy(joyId, idx) {
    const joy=document.getElementById(joyId); const stick=joy.firstElementChild;
    const handleMove=(e)=>{
        if(!joy.hasPointerCapture(e.pointerId))return;
        const r=joy.getBoundingClientRect(); const xRaw=e.clientX-(r.left+60); const yRaw=e.clientY-(r.top+60);
        const x=(idx===1)?-xRaw:xRaw; const y=(idx===1)?-yRaw:yRaw;
        const d=Math.min(45,Math.hypot(x,y)); const a=Math.atan2(y,x);
        stick.style.transform=`translate(${xRaw*(d/Math.hypot(xRaw,yRaw)||0)}px,${yRaw*(d/Math.hypot(xRaw,yRaw)||0)}px)`;
        tanks[idx].dx=Math.cos(a)*(d/45); tanks[idx].dy=Math.sin(a)*(d/45);
    };
    joy.onpointerdown=(e)=>{joy.setPointerCapture(e.pointerId);handleMove(e);};
    joy.onpointermove=handleMove; joy.onpointerup=()=>{stick.style.transform='';tanks[idx].dx=0;tanks[idx].dy=0;};
}
setupJoy('p1-joy',0); setupJoy('p2-joy',1);
const shoot=(idx)=>{if(!tanks[idx].dead)bullets.push({x:tanks[idx].x+Math.cos(tanks[idx].a)*40,y:tanks[idx].y+Math.sin(tanks[idx].a)*40,a:tanks[idx].a,owner:idx});};
document.getElementById('p1-fire').onpointerdown=(e)=>{e.preventDefault();shoot(0);};
document.getElementById('p2-fire').onpointerdown=(e)=>{e.preventDefault();shoot(1);};
update();
</script>
</body>
</html>
