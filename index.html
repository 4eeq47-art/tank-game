<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>БРОНЕТАНКИ: TOTAL REPAIR</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; touch-action: none; }
        canvas { position: absolute; top: 0; left: 0; display: block; }
        #ui { position: fixed; inset: 0; z-index: 100; pointer-events: none; display: none; }
        .score { position: absolute; width: 100%; text-align: center; color: #fff; font-size: 30px; font-weight: 900; text-shadow: 2px 2px 0 #000; }
        #score2 { top: 110px; transform: rotate(180deg); color: #ff5252; }
        #score1 { bottom: 135px; color: #69f0ae; }
        
        #menu { position: fixed; inset: 0; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); }
        .m-card { background: #222; padding: 30px; border-radius: 20px; border: 3px solid #444; text-align: center; }
        .btn { pointer-events: auto; width: 260px; padding: 15px; margin: 10px; font-size: 18px; font-weight: bold; color: #fff; background: #333; border: 2px solid #555; border-radius: 10px; }
        .btn.active { background: #2e7d32; border-color: #aeea00; }
        .start { background: #c62828; border-color: #ff5252; font-size: 24px; margin-top: 20px; }
        
        .ctrl { position: absolute; pointer-events: auto; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); }
        .joy { width: 150px; height: 150px; }
        .fire { width: 110px; height: 110px; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 900; }
        .stick { position: absolute; inset: 40px; background: rgba(255,255,255,0.3); border-radius: 50%; pointer-events: none; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<canvas id="gameCanvas"></canvas>

<div id="menu">
    <div class="m-card">
        <h1 style="color:#ffcc00; margin:0 0 20px 0;">БРОНЕТАНКИ</h1>
        <button class="btn active" id="pvp-btn">ИГРОК VS ИГРОК</button>
        <button class="btn" id="pve-btn">ИГРОК VS БОТ</button>
        <button class="btn start" id="start-btn">В БОЙ!</button>
    </div>
</div>

<div id="ui">
    <div id="score2" class="score">0</div>
    <div id="score1" class="score">0</div>
    <div id="p1-joy" class="ctrl joy" style="left:30px; bottom:30px;"><div class="stick"></div></div>
    <div id="p1-fire" class="ctrl fire" style="right:30px; bottom:30px;">ОГОНЬ</div>
    <div id="p2-joy" class="ctrl joy" style="right:30px; top:30px;"><div class="stick"></div></div>
    <div id="p2-fire" class="ctrl fire" style="left:30px; top:30px; transform: rotate(180deg);">ОГОНЬ</div>
</div>

<script>
const bgCvs = document.getElementById('bgCanvas');
const gCvs = document.getElementById('gameCanvas');
const bctx = bgCvs.getContext('2d');
const gctx = gCvs.getContext('2d');

let W, H, isGame = false, mode = 'pvp';
let tanks = [], bullets = [], bricks = [], explosions = [], sosSquad = [];

// --- КЛАСС ТАНКА ---
class Tank {
    constructor(id, color, isBot, isBottom) {
        this.id = id; this.color = color; this.isBot = isBot; this.isBottom = isBottom;
        this.score = 0; this.sosBuf = []; this.hp = 3; this.reset();
    }
    reset() {
        this.x = W/2; this.y = this.isBottom ? H-100 : 100;
        this.angle = this.isBottom ? -Math.PI/2 : Math.PI/2;
        this.hp = 3; this.dx = 0; this.dy = 0; this.lastS = 0; this.dead = false; this.deadT = 0;
    }
}

// --- ОТРИСОВКА (УПРОЩЕННАЯ И НАДЕЖНАЯ) ---
function drawTank(ctx, t) {
    ctx.save(); ctx.translate(t.x, t.y);
    // Полоска HP
    ctx.fillStyle = '#f00'; ctx.fillRect(-20, -35, 40, 4);
    ctx.fillStyle = '#0f0'; ctx.fillRect(-20, -35, 40 * (t.hp/3), 4);
    
    ctx.rotate(t.angle);
    if(t.dead) ctx.globalAlpha = 0.3;
    ctx.fillStyle = '#333'; ctx.fillRect(-24, -18, 48, 8); ctx.fillRect(-24, 10, 48, 8); // Гусеницы
    ctx.fillStyle = t.color; ctx.fillRect(-20, -12, 40, 24); // Корпус
    ctx.beginPath(); ctx.arc(0, 0, 12, 0, 7); ctx.fill(); ctx.stroke(); // Башня
    ctx.fillStyle = '#000'; ctx.fillRect(10, -3, 25, 6); // Ствол
    ctx.restore();
}

// --- ГЛАВНЫЕ ЦИКЛЫ ---
function init() {
    W = bgCvs.width = gCvs.width = window.innerWidth;
    H = bgCvs.height = gCvs.height = window.innerHeight;
}

// Заставка
let menuT = 0;
function loopMenu() {
    if(isGame) return;
    bctx.fillStyle = '#111'; bctx.fillRect(0,0,W,H);
    menuT += 0.01;
    // Рисуем декоративные танки
    for(let i=0; i<3; i++) {
        let tx = (menuT * 100 + i*200) % (W + 200) - 100;
        drawTank(bctx, {x: tx, y: H*0.7 + i*30, angle: 0, color: '#2e7d32', hp: 3});
        // Самолеты
        bctx.fillStyle = '#444'; bctx.fillRect(tx+100, 100+i*50, 40, 10);
        bctx.fillRect(tx+115, 85+i*50, 10, 40);
    }
    requestAnimationFrame(loopMenu);
}

function loopGame() {
    if(!isGame) return;
    gctx.fillStyle = '#1a1a1a'; gctx.fillRect(0,0,W,H);
    
    // Сетка и Кирпичи
    gctx.strokeStyle = '#222'; for(let i=0; i<W; i+=50) { gctx.beginPath(); gctx.moveTo(i,0); gctx.lineTo(i,H); gctx.stroke(); }
    bricks.forEach(b => { gctx.fillStyle = '#8d4925'; gctx.fillRect(b.x, b.y, 25, 15); gctx.strokeRect(b.x, b.y, 25, 15); });

    // Танки
    tanks.concat(sosSquad).forEach(t => {
        if(t.dead) { t.deadT++; if(t.deadT > 100) t.reset(); }
        else {
            if(t.isBot) {
                let tar = tanks[0]; let a = Math.atan2(tar.y-t.y, tar.x-t.x); t.angle = a;
                if(Math.hypot(tar.x-t.x, tar.y-t.y)>150){ t.dx=Math.cos(a); t.dy=Math.sin(a); } else { t.dx=0; t.dy=0; if(Math.random()<0.02) shoot(t); }
            }
            let nx = t.x + t.dx*3.5, ny = t.y + t.dy*3.5;
            if(!col(nx, t.y, 20)) t.x = nx; if(!col(t.x, ny, 20)) t.y = ny;
        }
        drawTank(gctx, t);
    });

    // Пули
    bullets.forEach((b, i) => {
        b.x += Math.cos(b.a)*12; b.y += Math.sin(b.a)*12;
        gctx.fillStyle = '#ff0'; gctx.beginPath(); gctx.arc(b.x, b.y, 4, 0, 7); gctx.fill();
        let hit = tanks.find(tk => !tk.dead && b.owner !== tk.id && Math.hypot(b.x-tk.x, b.y-tk.y) < 25);
        if(hit) { hit.hp--; explosions.push({x:b.x, y:b.y, l:10}); if(hit.hp<=0){ hit.dead=true; tanks[b.owner].score++; } bullets.splice(i,1); }
        else if(col(b.x, b.y, 5)) { bullets.splice(i,1); }
        if(b.x<0||b.x>W||b.y<0||b.y>H) bullets.splice(i,1);
    });

    document.getElementById('score1').innerText = tanks[0].score;
    document.getElementById('score2').innerText = tanks[1].score;
    requestAnimationFrame(loopGame);
}

function shoot(t) {
    if(t.dead || Date.now() - t.lastS < 300) return;
    bullets.push({x: t.x + Math.cos(t.angle)*40, y: t.y + Math.sin(t.angle)*40, a: t.angle, owner: t.id});
    t.lastS = Date.now();
}

function col(x, y, r) {
    if(x<r || x>W-r || y<r || y>H-r) return true;
    return bricks.some(b => x+r > b.x && x-r < b.x+25 && y+r > b.y && y-r < b.y+15);
}

// --- УПРАВЛЕНИЕ ---
const activeT = {};
function setupInp() {
    const h = (e) => {
        if(!isGame) return; e.preventDefault();
        for(let t of e.changedTouches) {
            const x = t.clientX, y = t.clientY;
            if(e.type==='touchstart' || e.type==='touchmove') {
                ['p1-joy','p2-joy'].forEach((id, i) => {
                    const r = document.getElementById(id).getBoundingClientRect();
                    if(x>r.left && x<r.right && y>r.top && y<r.bottom) {
                        let dx = (x-(r.left+r.width/2))/(r.width/2), dy = (y-(r.top+r.height/2))/(r.height/2);
                        let ang = Math.atan2(dy, dx), d = Math.min(1, Math.hypot(dx, dy));
                        tanks[i].dx = Math.cos(ang)*d; tanks[i].dy = Math.sin(ang)*d; tanks[i].angle = ang;
                        document.getElementById(id).querySelector('.stick').style.transform = `translate(${dx*30}px, ${dy*30}px)`;
                        activeT[t.identifier] = {type:'joy', i};
                    }
                });
                ['p1-fire','p2-fire'].forEach((id, i) => {
                    const r = document.getElementById(id).getBoundingClientRect();
                    if(x>r.left && x<r.right && y>r.top && y<r.bottom && e.type==='touchstart') {
                        shoot(tanks[i]);
                        activeT[t.identifier] = {type:'fire', i, ts: Date.now()};
                    }
                });
            }
            if(e.type==='touchend') {
                let d = activeT[t.identifier];
                if(d) {
                    if(d.type==='joy') { tanks[d.i].dx=0; tanks[d.i].dy=0; document.querySelectorAll('.stick')[d.i].style.transform='none'; }
                    if(d.type==='fire') {
                        let dur = Date.now()-d.ts; let tk = tanks[d.i];
                        tk.sosBuf.push(dur > 200 ? '-' : '.');
                        if(tk.sosBuf.join('').includes('...---...')) { 
                            for(let k=0; k<3; k++) { let s = new Tank(d.i, tk.color, true, false); s.x=Math.random()*W; s.y=H+100; sosSquad.push(s); }
                            tk.sosBuf = [];
                        }
                    }
                    delete activeT[t.identifier];
                }
            }
        }
    };
    ['touchstart','touchmove','touchend'].forEach(n => window.addEventListener(n, h, {passive:false}));
}

// --- СТАРТ ---
document.getElementById('start-btn').onclick = () => {
    isGame = true;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    tanks = [new Tank(0, '#388e3c', false, true), new Tank(1, '#d32f2f', mode==='pve', false)];
    if(mode==='pve') { document.getElementById('p2-joy').style.display='none'; document.getElementById('p2-fire').style.display='none'; }
    
    bricks = []; let cx = W/2 - 75;
    const rect = (x,y,w,h) => { for(let i=0; i<w; i++) for(let j=0; j<h; j++) bricks.push({x:x+i*26, y:y+j*16}); };
    rect(cx, 110, 6, 2); rect(cx, H-150, 6, 2);
    loopGame();
};

document.getElementById('pvp-btn').onclick = () => { mode='pvp'; document.getElementById('pvp-btn').className='btn active'; document.getElementById('pve-btn').className='btn'; };
document.getElementById('pve-btn').onclick = () => { mode='pve'; document.getElementById('pve-btn').className='btn active'; document.getElementById('pvp-btn').className='btn'; };

init(); loopMenu(); setupInp();
</script>
</body>
</html>
