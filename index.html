<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ТАНКИ: ГЕН-30 (ПОЛНЫЙ АРХИВ)</title>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: 'Courier New', monospace; color: white; }
        canvas { display: block; background: linear-gradient(to bottom, #0d121d 0%, #000 100%); }
        #gen-num { position: fixed; top: 10px; left: 10px; font-size: 14px; z-index: 10; font-weight: bold; }
        #lib-btn { position: fixed; top: 10px; right: 10px; z-index: 100; padding: 5px 15px; background: #333; color: #fff; border: 1px solid #777; cursor: pointer; }
        #library-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; display: none; padding: 20px; overflow-y: auto; }
        .lib-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .lib-col { border: 1px solid #444; padding: 10px; }
        .archive-item { background: #111; margin-bottom: 10px; padding: 10px; border: 1px solid #333; text-align: center; font-size: 10px; }
        canvas.prev { background: #000; border: 1px solid #444; margin-top: 5px; }
        .selector { margin: 10px 0; padding: 10px; background: #222; border: 1px solid #555; }
        .opt { cursor: pointer; padding: 3px 6px; margin: 2px; border: 1px solid #444; display: inline-block; font-size: 10px; }
        .active-opt { border-color: yellow; color: yellow; }
        .close-lib { float: right; cursor: pointer; color: red; }
    </style>
</head>
<body>

<div id="gen-num">ГЕНЕРАЦИЯ №30</div>
<button id="lib-btn" onclick="toggleLib()">БИБЛИОТЕКА</button>

<div id="library-overlay">
    <span class="close-lib" onclick="toggleLib()">[ЗАКРЫТЬ]</span>
    <h2>АРХИВ ГЕНЕРАЦИЙ (24-30)</h2>
    <div class="selector"><b>МАРШ (1-20):</b> <div id="m-list"></div></div>
    <div class="selector"><b>СВИСТ+ВЗРЫВ (1-20):</b> <div id="b-list"></div></div>
    <div class="lib-grid">
        <div class="lib-col" id="p-arch"><h3>САМОЛЕТЫ</h3></div>
        <div class="lib-col" id="t-arch"><h3>ТАНКИ</h3></div>
    </div>
</div>

<canvas id="battleCanvas"></canvas>

<script>
const canvas = document.getElementById('battleCanvas');
const ctx = canvas.getContext('2d');
let W, H, audioCtx, marchGain;
let selM = 6, selB = 0; // Марш №7 и Свист №1

const archive = [24, 25, 26, 27, 28, 29, 30];
const vehicles = [], planes = [], bombs = [], bullets = [], explosions = [], tankFlashes = [];

function initAudio() {
    if(!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        marchGain = audioCtx.createGain(); marchGain.gain.value = 0.2;
        marchGain.connect(audioCtx.destination);
        startMarchEngine(); buildSelectors();
    }
}

function startMarchEngine() {
    let step = 0;
    setInterval(() => {
        if(!audioCtx || audioCtx.state === 'suspended') return;
        const now = audioCtx.currentTime;
        // Удар сапога
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.frequency.setValueAtTime(50 + (selM % 5), now);
        g.gain.setValueAtTime(0.12, now); g.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        o.connect(g); g.connect(marchGain); o.start(); o.stop(now + 0.2);
        // Мелодия (Сложная)
        if(selM > 5) {
            const m = audioCtx.createOscillator(); const mg = audioCtx.createGain();
            const notes = [174, 196, 207, 233, 261, 233, 207, 196];
            m.type = 'sawtooth'; m.frequency.value = notes[step % 8] * (selM > 12 ? 0.5 : 1);
            mg.gain.setValueAtTime(0.04, now); mg.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
            m.connect(mg); mg.connect(marchGain); m.start(); m.stop(now + 0.4);
        }
        step++;
    }, 500);
}

function playExplosion(z) {
    if(!audioCtx) return;
    const now = audioCtx.currentTime;
    // Свист
    const s = audioCtx.createOscillator(); const sg = audioCtx.createGain();
    s.frequency.setValueAtTime(400 + (selB * 50), now);
    s.frequency.exponentialRampToValueAtTime(80, now + 1.6);
    sg.gain.setValueAtTime(0.08, now); sg.gain.linearRampToValueAtTime(0, now + 1.6);
    s.connect(sg); sg.connect(audioCtx.destination); s.start(); s.stop(now + 1.6);
    // Взрыв (Через 1.5с)
    setTimeout(() => {
        const n = audioCtx.createBufferSource();
        const b = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.8, audioCtx.sampleRate);
        const d = b.getChannelData(0); for(let i=0; i<d.length; i++) d[i] = Math.random() * 2 - 1;
        n.buffer = b; const ng = audioCtx.createGain(); const nf = audioCtx.createBiquadFilter();
        nf.type = 'lowpass'; nf.frequency.value = 60; ng.gain.value = 0.8 * z;
        n.connect(nf); nf.connect(ng); ng.connect(audioCtx.destination); n.start();
    }, 1500);
}

class Tank {
    constructor(y, speed, scale, color, z) {
        this.x = Math.random() * W; this.y = y; this.speed = speed; this.scale = scale; this.color = color; this.z = z;
        this.wAngle = 0; this.fireT = 150 + Math.random() * 200;
    }
    update() {
        this.x += this.speed; this.wAngle += this.speed * 0.12; // ВРАЩЕНИЕ КОЛЕС
        if(this.x > W + 200) this.x = -200;
        if(--this.fireT < 0) {
            tankFlashes.push({x: this.x + 65*this.scale, y: this.y - 12*this.scale, l: 1.0, s: this.scale});
            this.fireT = 300 + Math.random() * 300;
        }
    }
    draw(tCtx = ctx, tx = this.x, ty = this.y, ts = this.scale, tw = this.wAngle, isLegacy = false) {
        tCtx.save(); tCtx.translate(tx, ty); tCtx.scale(ts, ts);
        // Катки
        tCtx.fillStyle = '#111'; tCtx.fillRect(-45, 8, 90, 18);
        tCtx.fillStyle = '#333'; tCtx.strokeStyle = '#555';
        for(let i = -35; i <= 35; i += 14) {
            tCtx.save(); tCtx.translate(i, 18); if(!isLegacy) tCtx.rotate(tw);
            tCtx.beginPath(); tCtx.arc(0,0,6,0,7); tCtx.fill(); tCtx.stroke();
            tCtx.beginPath(); tCtx.moveTo(-4,0); tCtx.lineTo(4,0); tCtx.stroke(); tCtx.restore();
        }
        tCtx.fillStyle = this.color; tCtx.beginPath(); tCtx.moveTo(-45,10); tCtx.lineTo(-40,-5); tCtx.lineTo(35,-5); tCtx.lineTo(45,10); tCtx.fill();
        tCtx.fillStyle = '#111'; tCtx.fillRect(10, -10, 55, 6); tCtx.restore();
    }
}

class Plane {
    constructor(y, speed, type, z) {
        this.x = W + 400; this.y = y; this.baseY = y; this.speed = speed * 0.35; this.type = type; this.z = z; this.timer = 0;
    }
    update() {
        this.x -= this.speed; this.timer += 0.04;
        this.y = this.baseY + Math.sin(this.timer) * 30;
        if(this.type === 'bomber' && Math.random() < 0.005) {
            bombs.push({x:this.x, y:this.y, vy:1, z:this.z}); playExplosion(this.z);
        }
        if(this.x < -500) this.x = W + 500;
    }
    draw(tCtx = ctx, tx = this.x, ty = this.y, ts = this.z) {
        tCtx.save(); tCtx.translate(tx, ty); tCtx.scale(ts, ts);
        tCtx.fillStyle = '#3e4432';
        // НОВОЕ КРЫЛО (Обратная чайка)
        tCtx.beginPath(); tCtx.moveTo(0,0); tCtx.lineTo(-40, -15); tCtx.lineTo(-80, 5); tCtx.lineTo(-40, 20); tCtx.lineTo(0,5); tCtx.fill();
        tCtx.beginPath(); tCtx.moveTo(0,0); tCtx.lineTo(40, -15); tCtx.lineTo(80, 5); tCtx.lineTo(40, 20); tCtx.lineTo(0,5); tCtx.fill();
        // Фюзеляж и Хвост
        tCtx.fillRect(-10, -5, 20, 80); tCtx.fillStyle = '#222'; tCtx.fillRect(-30, 70, 60, 5);
        tCtx.restore();
    }
}

function buildSelectors() {
    const ml = document.getElementById('m-list'), bl = document.getElementById('b-list');
    ml.innerHTML = ''; bl.innerHTML = '';
    for(let i=0; i<20; i++) {
        let mo = document.createElement('div'); mo.className = 'opt'+(i==selM?' active-opt':''); mo.innerText = i+1;
        mo.onclick = () => { selM = i; buildSelectors(); }; ml.appendChild(mo);
        let bo = document.createElement('div'); bo.className = 'opt'+(i==selB?' active-opt':''); bo.innerText = i+1;
        bo.onclick = () => { selB = i; buildSelectors(); }; bl.appendChild(bo);
    }
}

function toggleLib() {
    const l = document.getElementById('library-overlay');
    l.style.display = l.style.display === 'block' ? 'none' : 'block';
    if(l.style.display === 'block') {
        const pa = document.getElementById('p-arch'), ta = document.getElementById('t-arch');
        pa.innerHTML = '<h3>САМОЛЕТЫ</h3>'; ta.innerHTML = '<h3>ТАНКИ</h3>';
        archive.forEach(num => {
            pa.innerHTML += `<div class="archive-item">ГЕН-${num}<canvas id="ap${num}" class="prev" width="160" height="80"></canvas></div>`;
            ta.innerHTML += `<div class="archive-item">ГЕН-${num}<canvas id="at${num}" class="prev" width="160" height="80"></canvas></div>`;
            setTimeout(() => {
                const pc = document.getElementById(`ap${num}`).getContext('2d'), tc = document.getElementById(`at${num}`).getContext('2d');
                if(num < 30) { // Имитация старых моделей
                    pc.fillStyle='#444'; pc.fillRect(40,35,80,10); tc.fillStyle='#444'; tc.fillRect(40,40,80,20);
                } else {
                    planes[0].draw(pc, 80, 10, 0.6); vehicles[2].draw(tc, 80, 30, 0.8, 0);
                }
            }, 50);
        });
    }
}

function resize() {
    W = window.innerWidth; H = window.innerHeight; canvas.width = W; canvas.height = H;
    vehicles.length = 0; planes.length = 0;
    vehicles.push(new Tank(H-160, 0.7, 0.5, '#1e2a1a', 0.5));
    vehicles.push(new Tank(H-110, 1.1, 0.8, '#2d4028', 0.8));
    vehicles.push(new Tank(H-55, 1.7, 1.25, '#3e5c36', 1.2));
    planes.push(new Plane(H*0.2, 4, 'bomber', 0.8));
    planes.push(new Plane(H*0.4, 5, 'bomber', 1.1));
}

function loop() {
    ctx.clearRect(0,0,W,H);
    planes.forEach(p => { p.update(); p.draw(); });
    vehicles.forEach(v => { v.update(); v.draw(); });
    tankFlashes.forEach((f, i) => {
        ctx.fillStyle = `rgba(255,255,0,${f.l})`; ctx.beginPath(); ctx.arc(f.x, f.y, 15*f.s, 0, 7); ctx.fill();
        f.l -= 0.1; if(f.l <= 0) tankFlashes.splice(i, 1);
    });
    bombs.forEach((b, i) => {
        b.y += b.vy; b.vy += 0.1; ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, 7); ctx.fill();
        let gr = b.z < 0.7 ? H-160 : (b.z < 1 ? H-110 : H-55);
        if(b.y > gr) { explosions.push({x:b.x, y:b.y, s:b.z, l:1.0}); bombs.splice(i,1); }
    });
    explosions.forEach((ex, i) => {
        ctx.fillStyle = `rgba(255,69,0,${ex.l})`; ctx.beginPath(); ctx.ellipse(ex.x, ex.y, 60*ex.s, 15*ex.s, 0, 0, 7); ctx.fill();
        ex.l -= 0.05; if(ex.l <= 0) explosions.splice(i, 1);
    });
    requestAnimationFrame(loop);
}

window.addEventListener('mousedown', initAudio);
window.addEventListener('resize', resize);
resize(); loop();
</script>
</body>
</html>
