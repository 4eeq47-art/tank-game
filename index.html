<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>БРОНЕТАНКИ: SOS EDITION</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #333; overflow: hidden; touch-action: none; font-family: 'Courier New', monospace; }
        canvas { display: block; position: absolute; inset: 0; }
        #bgCanvas { z-index: 1; }
        #gameCanvas { z-index: 5; display: none; background: #444; }
        
        #menu { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); }
        .m-card { background: #eee; padding: 25px; border: 4px solid #222; border-radius: 10px; text-align: center; width: 300px; }
        .btn { width: 100%; padding: 14px; margin: 6px 0; font-size: 18px; font-weight: 900; color: #fff; background: #444; border: 3px solid #000; cursor: pointer; }
        .btn.active { background: #2e7d32; border-color: #aeea00; }
        .start { background: #c62828; font-size: 24px; height: 70px; margin-top: 10px; }
        
        #ui { position: fixed; inset: 0; z-index: 10; pointer-events: none; display: none; }
        .score { position: absolute; width: 100%; text-align: center; font-size: 24px; font-weight: bold; color: #fff; text-shadow: 1px 1px 2px #000; }
        #score2 { top: 120px; transform: rotate(180deg); }
        #score1 { bottom: 140px; }
        
        .ctrl { position: absolute; pointer-events: auto; border-radius: 50%; border: 3px solid rgba(0,0,0,0.3); }
        .joy { width: 150px; height: 150px; background: rgba(255,255,255,0.1); }
        .fire { width: 110px; height: 110px; display: flex; align-items: center; justify-content: center; font-weight: 900; color: #fff; background: rgba(0,0,0,0.4); font-size: 16px; }
        .stick { position: absolute; width: 50px; height: 50px; border-radius: 50%; top: 47px; left: 47px; pointer-events: none; }
        
        #exit-btn { position: fixed; right: 10px; top: 50%; transform: translateY(-50%) rotate(90deg); z-index: 200; padding: 10px 20px; background: #222; color: #fff; border: 2px solid #fff; font-weight: bold; display: none; cursor: pointer; pointer-events: auto; }
        #gen-num { position: absolute; top: 10px; left: 10px; color: #000; font-size: 12px; opacity: 0.5; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<canvas id="gameCanvas"></canvas>

<div id="menu">
    <div id="gen-num">GEN: 4</div>
    <div class="m-card">
        <h1 style="color: #222; margin: 0 0 15px 0;">ТАНКИ: SOS</h1>
        <button class="btn active" id="pvp-btn">ИГРОК VS ИГРОК</button>
        <button class="btn" id="pve-btn">ИГРОК VS БОТ</button>
        <button class="btn start" id="start-btn">В БОЙ!</button>
    </div>
</div>

<div id="ui">
    <div id="score2" class="score">0</div>
    <div id="score1" class="score">0</div>
    <div id="p1-joy" class="ctrl joy" style="left:30px; bottom:30px;"><div class="stick" style="background: #2e7d32;"></div></div>
    <div id="p1-fire" class="ctrl fire" style="right:30px; bottom:30px; background: rgba(46,125,50,0.6);">ОГОНЬ</div>
    <div id="p2-joy" class="ctrl joy" style="right:30px; top:30px;"><div class="stick" style="background: #c62828;"></div></div>
    <div id="p2-fire" class="ctrl fire" style="left:30px; top:30px; transform: rotate(180deg); background: rgba(198,40,40,0.6);">ОГОНЬ</div>
</div>

<button id="exit-btn">В МЕНЮ</button>

<script>
const bgCvs = document.getElementById('bgCanvas'), gCvs = document.getElementById('gameCanvas');
const bctx = bgCvs.getContext('2d'), gctx = gCvs.getContext('2d');
let W, H, isGame = false, gameMode = 'pvp', audioCtx = null;
let tanks = [], bullets = [], bricks = [], explosions = [], sosSquad = [];
let sosBuffer = [], lastFireTime = 0;

// --- SOUND ---
function playSnd(f, t, d, v, s) {
    if(!audioCtx) return;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
    if(s) o.frequency.exponentialRampToValueAtTime(s, audioCtx.currentTime + d);
    g.gain.setValueAtTime(v, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + d);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + d);
}

// --- ТАНК ---
class Tank {
    constructor(id, color, isBot, isBottom) {
        this.id = id; this.color = color; this.isBot = isBot; this.isBottom = isBottom;
        this.score = 0; this.reset();
    }
    reset() {
        this.x = W/2; this.y = this.isBottom ? H-120 : 120;
        this.angle = this.isBottom ? -Math.PI/2 : Math.PI/2;
        this.hp = 3; this.dx = 0; this.dy = 0; this.flash = 0; this.dead = false; this.deadT = 0;
        this.lastS = 0; this.rev = 0;
    }
}

function drawTank(ctx, t) {
    ctx.save(); ctx.translate(t.x, t.y);
    ctx.fillStyle = '#000'; ctx.fillRect(t.isBottom?35:-40, -20, 6, 40);
    ctx.fillStyle = t.id===0?'#69f0ae':'#ff5252';
    ctx.fillRect(t.isBottom?35:-40, -20 + (40*(1-t.hp/3)), 6, 40*(t.hp/3));
    ctx.rotate(t.angle);
    if(t.dead) ctx.globalAlpha = 0.2;
    ctx.fillStyle = '#111'; ctx.fillRect(-26,-20,52,10); ctx.fillRect(-26,10,52,10);
    ctx.fillStyle = t.color; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.roundRect(-22,-16,44,32,4); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.arc(-2,0,15,0,7); ctx.fill(); ctx.stroke();
    ctx.fillStyle = '#111'; ctx.fillRect(12,-4,32,8); 
    ctx.fillStyle = t.color; ctx.fillRect(40,-8,10,16); ctx.strokeRect(40,-8,10,16);
    if(t.flash > 0) { ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(60, 0, 25, 0, 7); ctx.fill(); t.flash--; }
    ctx.restore();
}

// --- AI (FIXED NO-SPIN) ---
function runAI(t) {
    const tar = tanks[0];
    if(t.rev > 0) { t.dx = -Math.cos(t.angle); t.dy = -Math.sin(t.angle); t.angle += 0.05; t.rev--; return; }
    const dist = Math.hypot(tar.x - t.x, tar.y - t.y);
    if(col(t.x + Math.cos(t.angle)*40, t.y + Math.sin(t.angle)*40, 22)) { t.rev = 40; }
    else {
        let targetAngle = Math.atan2(tar.y - t.y, tar.x - t.x);
        t.angle = targetAngle;
        t.dx = Math.cos(t.angle); t.dy = Math.sin(t.angle);
        if(dist < 400 && Math.random() < 0.03) shoot(t);
    }
}

let mT = 0;
function loop() {
    W = window.innerWidth; H = window.innerHeight;
    bgCvs.width = gCvs.width = W; bgCvs.height = gCvs.height = H;

    if(!isGame) {
        bctx.fillStyle = '#eee'; bctx.fillRect(0,0,W,H);
        mT += 0.01;
        for(let i=0; i<2; i++) {
            let px = (mT*180 + i*600) % (W+400) - 200;
            bctx.fillStyle = '#555'; bctx.fillRect(px, 100+i*150, 65, 12); // Plane
            if(Math.floor(px)%450 === 0) { playSnd(850, 'sine', 1.4, 0.02, 100); explosions.push({x: px, y: H*0.8, l: 20}); }
            let tx = (mT*100 + i*400) % (W+200) - 100;
            drawTank(bctx, {x: tx, y: H-180-i*50, angle: 0, color: '#388e3c', hp: 3, id: 0, isBottom: true});
        }
    } else {
        gctx.fillStyle = '#444'; gctx.fillRect(0,0,W,H);
        bricks.forEach(b => { gctx.fillStyle = '#8d4925'; gctx.fillRect(b.x, b.y, 25, 15); gctx.strokeRect(b.x, b.y, 25, 15); });

        tanks.concat(sosSquad).forEach(t => {
            if(t.dead) { t.deadT++; if(t.deadT > 100) t.reset(); }
            else {
                if(t.isBot) runAI(t);
                let nx = t.x + t.dx*3.5, ny = t.y + t.dy*3.5;
                if(!col(nx, t.y, 22)) t.x = nx; if(!col(t.x, ny, 22)) t.y = ny;
            }
            drawTank(gctx, t);
        });

        bullets.forEach((b, i) => {
            b.x += Math.cos(b.a)*15; b.y += Math.sin(b.a)*15;
            gctx.fillStyle = '#fff'; gctx.beginPath(); gctx.arc(b.x, b.y, 5, 0, 7); gctx.fill();
            let hit = tanks.concat(sosSquad).find(tk => !tk.dead && b.owner !== tk.id && Math.hypot(b.x-tk.x, b.y-tk.y) < 25);
            if(hit) { hit.hp--; explosions.push({x:b.x, y:b.y, l:15}); if(hit.hp<=0){ hit.dead=true; if(b.owner < 2) tanks[b.owner].score++; } bullets.splice(i,1); }
            else if(col(b.x, b.y, 5)) { explosions.push({x:b.x, y:b.y, l:10}); bullets.splice(i,1); }
            if(b.x<0||b.x>W||b.y<0||b.y>H) bullets.splice(i,1);
        });
    }

    explosions.forEach((e, i) => {
        let c = isGame ? gctx : bctx;
        c.fillStyle = `rgba(255,255,255,${e.l/20})`; c.beginPath(); c.arc(e.x, e.y, 40-e.l, 0, 7); c.fill();
        e.l--; if(e.l<=0) explosions.splice(i, 1);
    });

    if(isGame) {
        document.getElementById('score1').innerText = tanks[0].score;
        document.getElementById('score2').innerText = tanks[1].score;
    }
    requestAnimationFrame(loop);
}

function shoot(t) {
    if(t.dead || Date.now() - t.lastS < 300) return;
    bullets.push({x: t.x + Math.cos(t.angle)*50, y: t.y + Math.sin(t.angle)*50, a: t.angle, owner: t.id});
    t.flash = 6; t.lastS = Date.now();
    playSnd(140, 'sawtooth', 0.1, 0.1);
}

function col(x, y, r) {
    if(x<r || x>W-r || y<r || y>H-r) return true;
    return bricks.some(b => x+r > b.x && x-r < b.x+25 && y+r > b.y && y-r < b.y+15);
}

// --- INPUT & EASTER EGG ---
const tMap = {};
let fireStart = 0;

function setupInp() {
    const h = (e) => {
        if(!isGame) return;
        for(let t of e.changedTouches) {
            const x = t.clientX, y = t.clientY;
            if(e.type==='touchstart' || e.type==='touchmove') {
                ['p1-joy','p2-joy'].forEach((id, i) => {
                    const r = document.getElementById(id).getBoundingClientRect();
                    const cx = r.left + r.width/2, cy = r.top + r.height/2;
                    if(Math.hypot(x-cx, y-cy) < 130) {
                        tMap[t.identifier] = i;
                        let dx = (x-cx)/(r.width/2), dy = (y-cy)/(r.height/2);
                        let a = Math.atan2(dy, dx), d = Math.min(1, Math.hypot(dx, dy));
                        tanks[i].dx = Math.cos(a)*d; tanks[i].dy = Math.sin(a)*d; tanks[i].angle = a;
                        document.getElementById(id).querySelector('.stick').style.transform = `translate(${dx*35}px, ${dy*35}px)`;
                    }
                });
                ['p1-fire','p2-fire'].forEach((id, i) => {
                    const r = document.getElementById(id).getBoundingClientRect();
                    if(x>r.left && x<r.right && y>r.top && y<r.bottom && e.type==='touchstart') {
                        shoot(tanks[i]);
                        if(i === 0) fireStart = Date.now();
                    }
                });
            }
            if(e.type==='touchend') {
                if(tMap[t.identifier] !== undefined) {
                    let i = tMap[t.identifier];
                    tanks[i].dx = 0; tanks[i].dy = 0;
                    document.querySelectorAll('.stick')[i].style.transform = 'none';
                    delete tMap[t.identifier];
                }
                // SOS Logic
                const r1 = document.getElementById('p1-fire').getBoundingClientRect();
                if(x>r1.left && x<r1.right && y>r1.top && y<r1.bottom) {
                    let dur = Date.now() - fireStart;
                    sosBuffer.push(dur > 300 ? '-' : '.');
                    if(sosBuffer.length > 9) sosBuffer.shift();
                    if(sosBuffer.join('').includes('...---...')) {
                        for(let k=0; k<3; k++) {
                            let s = new Tank(10+k, '#2e7d32', true, true);
                            s.x = (W/4)*(k+1); s.y = H+50; sosSquad.push(s);
                        }
                        sosBuffer = []; playSnd(440, 'square', 0.5, 0.2);
                    }
                }
            }
        }
    };
    ['touchstart','touchmove','touchend'].forEach(n => window.addEventListener(n, h, {passive:false}));
}

document.getElementById('start-btn').onclick = () => {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    isGame = true; gCvs.style.display = 'block';
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('exit-btn').style.display = 'block';
    tanks = [new Tank(0, '#2e7d32', false, true), new Tank(1, '#c62828', gameMode==='pve', false)];
    if(gameMode==='pve') { document.getElementById('p2-joy').style.display='none'; document.getElementById('p2-fire').style.display='none'; }
    
    bricks = []; let cx = W/2 - 75;
    const r = (x,y,w,h) => { for(let i=0; i<w; i++) for(let j=0; j<h; j++) bricks.push({x:x+i*26, y:y+j*16}); };
    // УКРЫТИЯ КАРМАНОМ К ИГРОКУ
    r(cx, 100, 1, 4); r(cx+130, 100, 1, 4); r(cx, 150, 6, 1); // Верх
    r(cx, H-166, 6, 1); r(cx, H-150, 1, 4); r(cx+130, H-150, 1, 4); // Низ
};

document.getElementById('pvp-btn').onclick = () => { gameMode='pvp'; document.getElementById('pvp-btn').className='btn active'; document.getElementById('pve-btn').className='btn'; };
document.getElementById('pve-btn').onclick = () => { gameMode='pve'; document.getElementById('pve-btn').className='btn active'; document.getElementById('pvp-btn').className='btn'; };
document.getElementById('exit-btn').onclick = () => location.reload();

loop(); setupInp();
</script>
</body>
</html>
