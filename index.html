<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>БРОНЕТАНКИ: ULTIMATE</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: #000; overflow: hidden; touch-action: none; font-family: 'Segoe UI', Bold, sans-serif; }
        canvas { display: block; position: absolute; inset: 0; }
        #bgCanvas { z-index: 1; }
        #gameCanvas { z-index: 5; display: none; }
        
        #menu { position: fixed; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); }
        .m-content { background: rgba(20,20,20,0.9); padding: 40px; border: 3px solid #555; border-radius: 20px; text-align: center; backdrop-filter: blur(10px); }
        .btn { pointer-events: auto; width: 280px; padding: 18px; margin: 10px; font-size: 22px; font-weight: 900; color: #fff; background: #333; border: 3px solid #555; border-radius: 12px; cursor: pointer; }
        .btn.active { background: #1b5e20; border-color: #aeea00; box-shadow: 0 0 20px #aeea0055; }
        .start { background: #b71c1c; border-color: #ff5252; font-size: 32px; height: 90px; margin-top: 20px; text-transform: uppercase; }
        
        #ui { position: fixed; inset: 0; z-index: 10; pointer-events: none; display: none; }
        .score { position: absolute; width: 100%; text-align: center; font-family: 'Courier New', monospace; font-size: 36px; font-weight: 900; text-shadow: 0 0 10px rgba(255,255,255,0.8); }
        #score2 { top: 108px; transform: rotate(180deg); color: #ff5252; }
        #score1 { bottom: 135px; color: #69f0ae; }
        
        .ctrl { position: absolute; pointer-events: auto; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); }
        .joy { width: 170px; height: 170px; background: rgba(255,255,255,0.05); }
        .fire { width: 130px; height: 130px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px; }
        .stick { position: absolute; width: 70px; height: 70px; border-radius: 50%; top: 47px; left: 47px; pointer-events: none; }
        
        #exit-game { position: fixed; right: 10px; top: 50%; transform: translateY(-50%) rotate(90deg); z-index: 200; padding: 10px 20px; background: #444; color: #fff; border: 2px solid #fff; border-radius: 5px; display: none; pointer-events: auto; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<canvas id="gameCanvas"></canvas>

<div id="menu">
    <div class="m-content">
        <h1 style="color: #ffeb3b; font-size: 48px; margin: 0 0 30px 0; text-shadow: 4px 4px 0 #bf360c;">БРОНЕТАНКИ</h1>
        <button class="btn active" id="pvp-btn">ИГРОК VS ИГРОК</button>
        <button class="btn" id="pve-btn">ИГРОК VS БОТ</button>
        <button class="btn start" id="start-btn">В БОЙ!</button>
        <p style="color: #aaa; margin-top: 15px;">Включайте звук для погружения</p>
    </div>
</div>

<div id="ui">
    <div id="score2" class="score">0</div>
    <div id="score1" class="score">0</div>
    <div id="p1-joy" class="ctrl joy" style="left:40px; bottom:40px;"><div class="stick" style="background: #2e7d32; box-shadow: 0 0 15px #aeea00;"></div></div>
    <div id="p1-fire" class="ctrl fire" style="right:40px; bottom:40px; background: rgba(46, 125, 50, 0.4); color: #fff; border-color: #aeea00;">ОГОНЬ</div>
    <div id="p2-joy" class="ctrl joy" style="right:40px; top:40px;"><div class="stick" style="background: #c62828; box-shadow: 0 0 15px #ff5252;"></div></div>
    <div id="p2-fire" class="ctrl fire" style="left:40px; top:40px; transform: rotate(180deg); background: rgba(198, 40, 40, 0.4); color: #fff; border-color: #ff5252;">ОГОНЬ</div>
</div>

<button id="exit-game">В МЕНЮ</button>

<script>
const bgCvs = document.getElementById('bgCanvas');
const gCvs = document.getElementById('gameCanvas');
const bctx = bgCvs.getContext('2d');
const gctx = gCvs.getContext('2d');

let W, H, isGame = false, gameMode = 'pvp';
let tanks = [], bullets = [], bricks = [], explosions = [], sosSquad = [];
let audioCtx = null;

// --- ЗВУКОВОЙ ДВИЖОК ---
function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    playMarch();
}

function playMarch() {
    const sequence = [220, 220, 220, 293, 329, 349, 349, 349];
    let i = 0;
    setInterval(() => {
        if (isGame) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(sequence[i % sequence.length], audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        i++;
    }, 600);
}

function playWhistle() {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.setValueAtTime(1500, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 1.5);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.5);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 1.5);
}

// --- ОТРИСОВКА ТАНКА (КРАСИВАЯ) ---
function drawDetailedTank(ctx, t) {
    ctx.save();
    ctx.translate(t.x, t.y);

    // HP Bar
    const barX = t.id === 0 ? 35 : -40; // У зеленого сзади
    ctx.fillStyle = '#000'; ctx.fillRect(barX, -25, 6, 50);
    ctx.fillStyle = t.hp > 1 ? (t.id === 0 ? '#69f0ae' : '#ff5252') : '#fff';
    ctx.fillRect(barX, -25 + (50 * (1 - t.hp/3)), 6, 50 * (t.hp/3));

    ctx.rotate(t.angle);
    if(t.isDead) ctx.globalAlpha = 0.3;

    // Тень
    ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.fillRect(-22, -14, 50, 35);

    // Гусеницы
    ctx.fillStyle = '#222';
    for(let i=-25; i<20; i+=6) {
        ctx.fillRect(i, -19, 4, 10);
        ctx.fillRect(i, 10, 4, 10);
    }
    
    // Корпус
    ctx.fillStyle = t.color; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.roundRect(-24, -16, 48, 32, 5); ctx.fill(); ctx.stroke();

    // Башня + Люк
    ctx.beginPath(); ctx.arc(-2, 0, 15, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.arc(-4, -4, 6, 0, 7); ctx.fill();

    // Дуло + Тормоз
    ctx.fillStyle = '#111'; ctx.fillRect(12, -4, 32, 8);
    ctx.fillStyle = t.color; ctx.fillRect(38, -7, 10, 14); ctx.strokeRect(38, -7, 10, 14);

    if(t.flash > 0) {
        ctx.fillStyle = '#ffeb3b'; ctx.beginPath(); ctx.arc(55, 0, 25 * (t.flash/5), 0, 7); ctx.fill();
        t.flash--;
    }
    ctx.restore();
}

// --- ЛОГИКА ИИ (ВЫЕЗД ИЗ УКРЫТИЯ) ---
function updateAI(t) {
    const target = tanks[0];
    const targetAngle = Math.atan2(target.y - t.y, target.x - t.x);
    
    // Проверка столкновения
    const fwdX = t.x + Math.cos(t.angle) * 35;
    const fwdY = t.y + Math.sin(t.angle) * 35;
    
    if (colCheck(fwdX, fwdY, 22)) {
        // МАНЕВР: Назад и Вправо
        t.dx = -Math.cos(t.angle) * 0.8;
        t.dy = -Math.sin(t.angle) * 0.8;
        t.angle += 0.05; // Поворот вправо при отъезде
    } else {
        t.angle = targetAngle;
        t.dx = Math.cos(t.angle);
        t.dy = Math.sin(t.angle);
        if(Math.random() < 0.03) shoot(t);
    }
}

// --- ИГРОВОЙ ЦИКЛ ---
function loop() {
    if(!isGame) {
        drawMenuBG();
    } else {
        drawGame();
    }
    requestAnimationFrame(loop);
}

let mTime = 0;
function drawMenuBG() {
    W = bgCvs.width = window.innerWidth; H = bgCvs.height = window.innerHeight;
    bctx.fillStyle = '#1a1a2e'; bctx.fillRect(0,0,W,H);
    mTime += 0.005;

    // Самолеты (детализированные)
    for(let i=0; i<2; i++) {
        let px = (mTime * 300 + i*600) % (W + 400) - 200;
        let py = 100 + i*80;
        if(px < -190) playWhistle();
        bctx.save(); bctx.translate(px, py);
        bctx.fillStyle = '#444'; bctx.fillRect(0, 0, 60, 12); // Фюзеляж
        bctx.fillStyle = '#333'; bctx.fillRect(15, -25, 15, 60); // Крылья
        bctx.fillStyle = '#ffeb3b'; bctx.fillRect(58, 2, 5, 8); // Пропеллер
        bctx.restore();
    }

    // Танки сбоку
    for(let i=0; i<3; i++) {
        let tx = (mTime * 150 + i*400) % (W + 300) - 150;
        let ty = H*0.7 + i*40;
        let scale = 0.8 + (i*0.3);
        bctx.save(); bctx.translate(tx, ty); bctx.scale(scale, scale);
        bctx.fillStyle = '#2e7d32'; bctx.fillRect(0,0,60,20); // Корпус
        bctx.fillStyle = '#1b5e20'; bctx.beginPath(); ctxArc(bctx, 25, 0, 15); bctx.fill(); // Башня
        bctx.fillStyle = '#111'; bctx.fillRect(40, -2, 35, 6); // Дуло
        bctx.restore();
    }
}

function ctxArc(ctx, x, y, r) { ctx.beginPath(); ctx.arc(x,y,r,0,7); }

function drawGame() {
    gctx.fillStyle = '#151515'; gctx.fillRect(0,0,W,H);
    // Сетка
    gctx.strokeStyle = '#222'; gctx.lineWidth = 1;
    for(let i=0; i<W; i+=50) { gctx.beginPath(); gctx.moveTo(i,0); gctx.lineTo(i,H); gctx.stroke(); }

    bricks.forEach(b => {
        gctx.fillStyle = '#8d4925'; gctx.fillRect(b.x, b.y, 25, 15);
        gctx.strokeStyle = '#5d2905'; gctx.strokeRect(b.x, b.y, 25, 15);
    });

    tanks.concat(sosSquad).forEach(t => {
        if(t.isDead) { t.deadT++; if(t.deadT > 80) t.reset(); }
        else {
            if(t.isBot) updateAI(t);
            let nx = t.x + t.dx*3.8, ny = t.y + t.dy*3.8;
            if(!colCheck(nx, t.y, 22)) t.x = nx; if(!colCheck(t.x, ny, 22)) t.y = ny;
        }
        drawDetailedTank(gctx, t);
    });

    bullets.forEach((b, i) => {
        b.x += Math.cos(b.a)*15; b.y += Math.sin(b.a)*15;
        gctx.fillStyle = '#fff'; ctxArc(gctx, b.x, b.y, 4); gctx.fill();
        
        let hit = tanks.find(tk => !tk.isDead && b.owner !== tk.id && Math.hypot(b.x-tk.x, b.y-tk.y) < 25);
        if(hit) { 
            hit.hp--; explosions.push({x:b.x, y:b.y, l:15}); 
            if(hit.hp<=0){ hit.isDead=true; tanks[b.owner].score++; } 
            bullets.splice(i,1); 
        }
        else if(colCheck(b.x, b.y, 5)) { explosions.push({x:b.x, y:b.y, l:10}); bullets.splice(i,1); }
    });

    explosions.forEach((e, i) => {
        gctx.fillStyle = `rgba(255,${100+e.l*10},0,${e.l/15})`;
        ctxArc(gctx, e.x, e.y, 40 - e.l); gctx.fill();
        e.l--; if(e.l<=0) explosions.splice(i, 1);
    });

    document.getElementById('score1').innerText = tanks[0].score;
    document.getElementById('score2').innerText = tanks[1].score;
}

function shoot(t) {
    if(t.isDead || Date.now() - t.lastS < 280) return;
    bullets.push({x: t.x + Math.cos(t.angle)*50, y: t.y + Math.sin(t.angle)*50, a: t.angle, owner: t.id});
    t.flash = 5; t.lastS = Date.now();
}

function colCheck(x, y, r) {
    if(x<r || x>W-r || y<r || y>H-r) return true;
    return bricks.some(b => x+r > b.x && x-r < b.x+25 && y+r > b.y && y-r < b.y+15);
}

// --- УПРАВЛЕНИЕ (УЛУЧШЕННОЕ) ---
const activeTouches = {};
function setupInput() {
    const handle = (e) => {
        if(!isGame) return; e.preventDefault();
        const touches = e.changedTouches;
        for(let t of touches) {
            const x = t.clientX, y = t.clientY;
            
            if(e.type === 'touchstart' || e.type === 'touchmove') {
                // Джойстики (работают даже за пределами круга)
                ['p1-joy', 'p2-joy'].forEach((id, idx) => {
                    const el = document.getElementById(id); const r = el.getBoundingClientRect();
                    const cx = r.left + r.width/2, cy = r.top + r.height/2;
                    const distToJoy = Math.hypot(x - cx, y - cy);
                    
                    if(distToJoy < 150) { // Радиус захвата пальца увеличен
                        let dx = (x - cx)/80, dy = (y - cy)/80;
                        let d = Math.min(1, Math.hypot(dx, dy)), a = Math.atan2(dy, dx);
                        tanks[idx].dx = Math.cos(a)*d; tanks[idx].dy = Math.sin(a)*d; tanks[idx].angle = a;
                        el.querySelector('.stick').style.transform = `translate(${dx*40}px, ${dy*40}px)`;
                        activeTouches[t.identifier] = {type:'joy', idx};
                    }
                });
                
                // Кнопки огня
                ['p1-fire', 'p2-fire'].forEach((id, idx) => {
                    const el = document.getElementById(id); const r = el.getBoundingClientRect();
                    if(x > r.left && x < r.right && y > r.top && y < r.bottom) {
                        if(e.type === 'touchstart') shoot(tanks[idx]);
                    }
                });
            }
            
            if(e.type === 'touchend') {
                const data = activeTouches[t.identifier];
                if(data && data.type === 'joy') {
                    tanks[data.idx].dx = 0; tanks[data.idx].dy = 0;
                    document.querySelectorAll('.stick')[data.idx].style.transform = 'none';
                }
                delete activeTouches[t.identifier];
            }
        }
    };
    ['touchstart', 'touchmove', 'touchend'].forEach(ev => window.addEventListener(ev, handle, {passive:false}));
}

// --- ЗАПУСК ---
document.getElementById('start-btn').onclick = () => {
    initAudio();
    isGame = true;
    gCvs.style.display = 'block';
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('exit-game').style.display = 'block';
    W = gCvs.width = window.innerWidth; H = gCvs.height = window.innerHeight;
    
    tanks = [new Tank(0, '#388e3c', false, true), new Tank(1, '#d32f2f', gameMode==='pve', false)];
    if(gameMode==='pve') { document.getElementById('p2-joy').style.display='none'; document.getElementById('p2-fire').style.display='none'; }
    
    bricks = []; const cx = W/2 - 75;
    const rect = (x,y,w,h) => { for(let i=0; i<w; i++) for(let j=0; j<h; j++) bricks.push({x:x+i*26, y:y+j*16}); };
    // П-ОБРАЗНЫЕ УКРЫТИЯ
    rect(cx, 110, 6, 2); rect(cx, 142, 1, 3); rect(cx+130, 142, 1, 3); // Top P
    rect(cx, H-150, 6, 2); rect(cx, H-200, 1, 3); rect(cx+130, H-200, 1, 3); // Bot P
};

document.getElementById('pvp-btn').onclick = () => { gameMode='pvp'; document.getElementById('pvp-btn').className='btn active'; document.getElementById('pve-btn').className='btn'; };
document.getElementById('pve-btn').onclick = () => { gameMode='pve'; document.getElementById('pve-btn').className='btn active'; document.getElementById('pvp-btn').className='btn'; };
document.getElementById('exit-game').onclick = () => location.reload();

class Tank {
    constructor(id, color, isBot, isBottom) {
        this.id = id; this.color = color; this.isBot = isBot; this.isBottom = isBottom;
        this.score = 0; this.reset();
    }
    reset() {
        this.x = W/2; this.y = this.isBottom ? H-100 : 100;
        this.angle = this.isBottom ? -Math.PI/2 : Math.PI/2;
        this.hp = 3; this.dx = 0; this.dy = 0; this.flash = 0; this.isDead = false; this.deadT = 0; this.lastS = 0;
    }
}

loop(); setupInput();
</script>
</body>
</html>
