<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tanks Pro Fixed</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: sans-serif; -webkit-user-select: none; }
        canvas { display: block; }
        
        /* Очки по середине сторон */
        .score { position: absolute; width: 100%; text-align: center; font-size: 24px; font-weight: bold; z-index: 100; pointer-events: none; opacity: 0.8; }
        #s1 { bottom: 20px; color: #0f0; }
        #s2 { top: 20px; color: #f00; transform: rotate(180deg); }
        
        .joy-zone { position: fixed; width: 130px; height: 130px; background: rgba(255,255,255,0.03); border-radius: 50%; z-index: 200; touch-action: none; }
        .stick { position: absolute; width: 50px; height: 50px; border-radius: 50%; top: 40px; left: 40px; pointer-events: none; }
        
        /* Кнопка ОГОНЬ с разворотом текста */
        .btn-fire { position: fixed; width: 110px; height: 110px; border-radius: 50%; z-index: 200; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; touch-action: none; font-size: 16px; border: none; outline: none; }
        .btn-fire span { transform: rotate(90deg); display: inline-block; }

        /* --- ЗЕЛЕНЫЙ (P1) --- */
        #p1-joy { bottom: 10%; left: 5%; } /* Джойстик СЛЕВА */
        #p1-fire { bottom: 10%; right: 5%; background: rgba(0,255,0,0.25); color: #0f0; } /* Огонь СПРАВА */
        #p1-stick { background: #0f0; box-shadow: 0 0 15px #0f0; }

        /* --- КРАСНЫЙ (P2) --- */
        #p2-joy { top: 10%; right: 5%; } /* Джойстик СЛЕВА (для него) */
        #p2-fire { top: 10%; left: 5%; background: rgba(255,0,0,0.25); color: #f00; transform: rotate(180deg); } /* Огонь СПРАВА (для него) */
        #p2-fire span { transform: rotate(90deg); } /* Текст внутри повернутой кнопки */
        #p2-stick { background: #f00; box-shadow: 0 0 15px #f00; }
    </style>
</head>
<body>
    <div id="s2" class="score">Красный: 0</div>
    <div id="s1" class="score">Зеленый: 0</div>
    <canvas id="g"></canvas>
    
    <div id="p1-joy" class="joy-zone"><div id="p1-stick" class="stick"></div></div>
    <div id="p1-fire" class="btn-fire"><span>ОГОНЬ</span></div>

    <div id="p2-joy" class="joy-zone"><div id="p2-stick" class="stick"></div></div>
    <div id="p2-fire" class="btn-fire"><span>ОГОНЬ</span></div>

<script>
const cvs = document.getElementById('g'); const ctx = cvs.getContext('2d');
function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

let bullets = [], explosions = [], surrenderAnimations = [];
const gap = 100;
let deathCounts = [0, 0]; // Счетчик смертей [зеленый, красный]

let tanks = [
    { x: gap, y: cvs.height/2, c: 'green', a: 0, s: 0, hp: 3, dx:0, dy:0, id: 0 },
    { x: cvs.width - gap, y: cvs.height/2, c: 'red', a: Math.PI, s: 0, hp: 3, dx:0, dy:0, id: 1 }
];

function drawSurrender(anim) {
    ctx.save(); ctx.translate(anim.x, anim.y);
    if(anim.id === 1) ctx.rotate(Math.PI); // Разворот для красного
    // Человечек
    ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(0, -10, 5, 0, 7); ctx.fill(); // Голова
    ctx.fillRect(-2, -5, 4, 10); // Туловище
    // Флаг
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(2, 0); ctx.lineTo(2, -20); ctx.stroke();
    ctx.fillStyle = "#fff";
    let wave = Math.sin(Date.now() / 100) * 3;
    ctx.fillRect(2, -20, 12 + wave, 8);
    ctx.restore();
}

function drawTank(t) {
    ctx.save(); ctx.translate(t.x, t.y); ctx.rotate(t.a);
    ctx.fillStyle = t.c; ctx.beginPath(); ctx.roundRect(-24, -20, 48, 40, 12); ctx.fill();
    ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.arc(0, 0, 12, 0, 7); ctx.fill();
    ctx.fillStyle = '#888'; ctx.fillRect(15, -5, 25, 10); ctx.restore();
    const bw = 46, bh = 8;
    ctx.strokeStyle = '#333'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.roundRect(t.x - bw/2, t.y - 45, bw, bh, 4); ctx.stroke();
    ctx.fillStyle = t.id === 0 ? '#0f0' : '#f00';
    ctx.beginPath(); ctx.roundRect(t.x - bw/2 + 1, t.y - 44, (t.hp/3)*(bw-2), bh-2, 3); ctx.fill();
}

function update() {
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,cvs.width,cvs.height);
    
    // Стены
    ctx.fillStyle = '#222';
    const walls = [
        {x: gap-20, y: cvs.height/2-80, w: 100, h: 10}, {x: gap-20, y: cvs.height/2+70, w: 100, h: 10}, {x: gap+80, y: cvs.height/2-80, w: 10, h: 160},
        {x: cvs.width-gap-80, y: cvs.height/2-80, w: 100, h: 10}, {x: cvs.width-gap-80, y: cvs.height/2+70, w: 100, h: 10}, {x: cvs.width-gap-90, y: cvs.height/2-80, w: 10, h: 160}
    ];
    walls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));

    // Анимация сдачи
    surrenderAnimations = surrenderAnimations.filter(a => {
        if(Date.now() - a.start < 3000) { drawSurrender(a); return true; }
        return false;
    });

    explosions.forEach((ex, i) => {
        ctx.beginPath(); ctx.arc(ex.x, ex.y, ex.r, 0, 7);
        ctx.fillStyle = `rgba(255,100,0,${ex.a})`; ctx.fill();
        ex.r += 3; ex.a -= 0.05; if(ex.a<=0) explosions.splice(i,1);
    });

    tanks.forEach(t => {
        if (Math.abs(t.dx) > 0.1 || Math.abs(t.dy) > 0.1) {
            let nX = t.x + t.dx * 3.5; let nY = t.y + t.dy * 3.5;
            let col = walls.some(w => nX+24 > w.x && nX-24 < w.x+w.w && nY+24 > w.y && nY-24 < w.y+w.h);
            if(!col) { t.x = nX; t.y = nY; }
            t.a = Math.atan2(t.dy, t.dx);
        }
        t.x = Math.max(25, Math.min(cvs.width-25, t.x));
        t.y = Math.max(25, Math.min(cvs.height-25, t.y));
        drawTank(t);
    });

    for (let i = bullets.length-1; i >= 0; i--) {
        let b = bullets[i]; b.x += Math.cos(b.a)*12; b.y += Math.sin(b.a)*12;
        ctx.fillStyle = 'yellow'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, 7); ctx.fill();
        let hit = false;
        if(walls.some(w => b.x > w.x && b.x < w.x+w.w && b.y > w.y && b.y < w.y+w.h)) hit = true;
        tanks.forEach(t => {
            if (b.owner !== t.id && Math.hypot(b.x-t.x, b.y-t.y) < 30) {
                t.hp--; 
                if(t.hp <= 0) {
                    explosions.push({x:t.x, y:t.y, r:30, a:1});
                    deathCounts[t.id]++;
                    if(deathCounts[t.id] % 10 === 0) {
                        surrenderAnimations.push({x: t.x, y: t.y, id: t.id, start: Date.now()});
                    }
                    tanks[b.owner].s++;
                    document.getElementById('s'+(b.owner+1)).innerText = (b.owner===0?'Зеленый: ':'Красный: ')+tanks[b.owner].s;
                    t.x = t.id===0?gap:cvs.width-gap; t.y = cvs.height/2; t.hp = 3;
                } else { explosions.push({x:b.x, y:b.y, r:6, a:1}); }
                hit = true;
            }
        });
        if(hit || b.x<0 || b.x>cvs.width || b.y<0 || b.y>cvs.height) bullets.splice(i,1);
    }
    requestAnimationFrame(update);
}

function setupJoy(joyId, stickId, idx) {
    const joy = document.getElementById(joyId); const stick = document.getElementById(stickId);
    const move = (clientX, clientY) => {
        const r = joy.getBoundingClientRect(); 
        const xRaw = clientX - (r.left + r.width/2); 
        const yRaw = clientY - (r.top + r.height/2);
        const x = idx === 1 ? -xRaw : xRaw;
        const y = idx === 1 ? -yRaw : yRaw;
        const d = Math.min(45, Math.hypot(x,y)); const a = Math.atan2(y,x);
        stick.style.transform = `translate(${xRaw * (d/Math.hypot(xRaw,yRaw) || 0)}px, ${yRaw * (d/Math.hypot(xRaw,yRaw) || 0)}px)`;
        tanks[idx].dx = Math.cos(a)*(d/45); tanks[idx].dy = Math.sin(a)*(d/45);
    };
    joy.addEventListener('pointerdown', (e) => { joy.setPointerCapture(e.pointerId); move(e.clientX, e.clientY); });
    joy.addEventListener('pointermove', (e) => { if(joy.hasPointerCapture(e.pointerId)) move(e.clientX, e.clientY); });
    joy.addEventListener('pointerup', (e) => { stick.style.transform = ''; tanks[idx].dx = 0; tanks[idx].dy = 0; });
}

setupJoy('p1-joy', 'p1-stick', 0);
setupJoy('p2-joy', 'p2-stick', 1);

const shoot = (idx) => bullets.push({x:tanks[idx].x+Math.cos(tanks[idx].a)*40, y:tanks[idx].y+Math.sin(tanks[idx].a)*40, a:tanks[idx].a, owner:idx});
document.getElementById('p1-fire').addEventListener('pointerdown', (e) => { e.preventDefault(); shoot(0); });
document.getElementById('p2-fire').addEventListener('pointerdown', (e) => { e.preventDefault(); shoot(1); });

update();
</script>
</body>
</html>
