<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tanks Vertical Setup</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: sans-serif; -webkit-user-select: none; }
        canvas { display: block; }
        
        /* МЕНЮ НАСТРОЕК */
        #setup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 500; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; gap: 10px;
        }
        .setup-row { display: flex; width: 100%; justify-content: space-around; align-items: center; flex: 1; }
        .player-box { padding: 10px; border-radius: 15px; background: rgba(255,255,255,0.05); width: 85%; text-align: center; border: 2px solid #333; }
        .p1-box { border-color: #0f0; }
        .p2-box { border-color: #f00; transform: rotate(180deg); }
        
        .control-group { margin: 5px 0; display: inline-block; padding: 0 10px; }
        .btn-toggle {
            padding: 10px 15px; margin: 3px; font-size: 13px; cursor: pointer;
            background: #222; color: #aaa; border: 1px solid #444; border-radius: 6px;
        }
        .active { background: #444; color: #fff; border-color: #fff; font-weight: bold; }

        /* МИНИ-КАРТА (ВЕРТИКАЛЬНАЯ) */
        #map-preview {
            width: 120px; height: 180px; border: 2px solid #444; position: relative;
            background: #050505; border-radius: 10px; margin: 10px 0;
        }
        .base-p { position: absolute; width: 60px; height: 20px; border-radius: 4px; font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center; left: 30px; }
        #b-red { top: 5px; background: #f00; color: #fff; }
        #b-green { bottom: 5px; background: #0f0; color: #000; }
        
        .dot { position: absolute; width: 12px; height: 12px; border-radius: 50%; opacity: 0.3; border: 1px solid #fff; }
        .dot.active { opacity: 1; transform: scale(1.2); }

        #start-btn {
            padding: 15px 40px; font-size: 18px; background: #fff; color: #000;
            border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
        }

        .score { position: absolute; width: 100%; text-align: center; font-size: 20px; font-weight: bold; z-index: 100; pointer-events: none; }
        #s1 { bottom: 150px; color: #0f0; }
        #s2 { top: 150px; color: #f00; transform: rotate(180deg); }
        
        .joy-zone, .btn-fire { position: fixed; border-radius: 50%; z-index: 200; touch-action: none; border: none; visibility: hidden; }
        .joy-zone { width: 100px; height: 100px; background: rgba(255,255,255,0.1); }
        .stick { position: absolute; width: 40px; height: 40px; border-radius: 50%; top: 30px; left: 30px; pointer-events: none; }
        .btn-fire { width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
        .btn-fire span { transform: rotate(180deg); display: inline-block; }
        
        #p1-stick { background: #0f0; }
        #p2-stick { background: #f00; }
        #p1-fire { background: rgba(0,255,0,0.3); color: #0f0; }
        #p2-fire { background: rgba(255,0,0,0.3); color: #f00; transform: rotate(180deg); }
    </style>
</head>
<body>

    <div id="setup-overlay">
        <div class="player-box p2-box">
            <b>КРАСНЫЙ (ВЕРХНЯЯ БАЗА)</b><br>
            <div class="control-group">ДЖОЙСТИК: 
                <button class="btn-toggle active" onclick="setCfg(1,'j','L',event)">СЛЕВА</button>
                <button class="btn-toggle" onclick="setCfg(1,'j','R',event)">СПРАВА</button>
            </div>
            <div class="control-group">ОГОНЬ: 
                <button class="btn-toggle" onclick="setCfg(1,'f','L',event)">СЛЕВА</button>
                <button class="btn-toggle active" onclick="setCfg(1,'f','R',event)">СПРАВА</button>
            </div>
        </div>

        <div id="map-preview">
            <div id="b-red" class="base-p">БАЗА</div>
            <div id="dot-2-L" class="dot" style="top:5px; right:5px; background:#f00;"></div>
            <div id="dot-2-R" class="dot" style="top:5px; left:5px; background:#f00;"></div>
            
            <div id="b-green" class="base-p">БАЗА</div>
            <div id="dot-1-L" class="dot" style="bottom:5px; left:5px; background:#0f0;"></div>
            <div id="dot-1-R" class="dot" style="bottom:5px; right:5px; background:#0f0;"></div>
        </div>
        
        <button id="start-btn" onclick="startGame()">В БОЙ!</button>

        <div class="player-box p1-box">
            <b>ЗЕЛЕНЫЙ (НИЖНЯЯ БАЗА)</b><br>
            <div class="control-group">ДЖОЙСТИК: 
                <button class="btn-toggle active" onclick="setCfg(0,'j','L',event)">СЛЕВА</button>
                <button class="btn-toggle" onclick="setCfg(0,'j','R',event)">СПРАВА</button>
            </div>
            <div class="control-group">ОГОНЬ: 
                <button class="btn-toggle" onclick="setCfg(0,'f','L',event)">СЛЕВА</button>
                <button class="btn-toggle active" onclick="setCfg(0,'f','R',event)">СПРАВА</button>
            </div>
        </div>
    </div>

    <div id="s2" class="score">Красный: 0</div>
    <div id="s1" class="score">Зеленый: 0</div>
    <canvas id="g"></canvas>
    
    <div id="p1-fire" class="btn-fire"><span>ОГОНЬ</span></div>
    <div id="p1-joy" class="joy-zone"><div id="p1-stick" class="stick"></div></div>
    <div id="p2-fire" class="btn-fire"><span>ОГОНЬ</span></div>
    <div id="p2-joy" class="joy-zone"><div id="p2-stick" class="stick"></div></div>

<script>
const cvs = document.getElementById('g'); const ctx = cvs.getContext('2d');
let gameStarted = false;
let cfg = [ {j:'L', f:'R'}, {j:'L', f:'R'} ];

function setCfg(p, type, side, e) {
    cfg[p][type] = side;
    e.target.parentElement.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    updateMap();
}

function updateMap() {
    document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
    // Зеленый
    document.getElementById('dot-1-' + cfg[0].j).classList.add('active');
    document.getElementById('dot-1-' + cfg[0].f).classList.add('active');
    // Красный (инверсия сторон для предпросмотра)
    document.getElementById('dot-2-' + cfg[1].j).classList.add('active');
    document.getElementById('dot-2-' + cfg[1].f).classList.add('active');
}
updateMap();

function startGame() {
    const p1j=document.getElementById('p1-joy'), p1f=document.getElementById('p1-fire');
    const p2j=document.getElementById('p2-joy'), p2f=document.getElementById('p2-fire');
    
    // Зеленый (Нижняя короткая сторона)
    p1j.style.left = cfg[0].j === 'L' ? '20px' : 'auto'; p1j.style.right = cfg[0].j === 'R' ? '20px' : 'auto';
    p1f.style.left = cfg[0].f === 'L' ? '20px' : 'auto'; p1f.style.right = cfg[0].f === 'R' ? '20px' : 'auto';
    
    // Красный (Верхняя короткая сторона). Для него L - это физически ПРАВО
    p2j.style.right = cfg[1].j === 'L' ? '20px' : 'auto'; p2j.style.left = cfg[1].j === 'R' ? '20px' : 'auto';
    p2f.style.right = cfg[1].f === 'L' ? '20px' : 'auto'; p2f.style.left = cfg[1].f === 'R' ? '20px' : 'auto';

    [p1j, p1f].forEach(el => el.style.bottom = '20px');
    [p2j, p2f].forEach(el => el.style.top = '20px');

    document.getElementById('setup-overlay').style.display = 'none';
    document.querySelectorAll('.joy-zone, .btn-fire').forEach(el => el.style.visibility = 'visible');
    gameStarted = true;
    resize();
}

function resize() {
    cvs.width = window.innerWidth; cvs.height = window.innerHeight;
    if(tanks) {
        tanks[0].x = cvs.width/2; tanks[0].y = cvs.height - 60;
        tanks[1].x = cvs.width/2; tanks[1].y = 60;
    }
}
window.addEventListener('resize', resize);

let bullets = [], explosions = [], surrenderAnims = [];
let deathCounts = { 0: 0, 1: 0 };
let tanks = [
    { x: 0, y: 0, c: 'green', a: -Math.PI/2, s: 0, hp: 3, dx:0, dy:0, id: 0, dead: false },
    { x: 0, y: 0, c: 'red', a: Math.PI/2, s: 0, hp: 3, dx:0, dy:0, id: 1, dead: false }
];

function drawTank(t) {
    ctx.save(); ctx.translate(t.x, t.y); ctx.rotate(t.a);
    ctx.fillStyle = t.dead ? '#111' : t.c;
    ctx.beginPath(); ctx.roundRect(-20, -18, 40, 36, 8); ctx.fill();
    ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.arc(0, 0, 10, 0, 7); ctx.fill();
    ctx.fillStyle = t.dead ? '#000' : '#777'; ctx.fillRect(12, -4, 20, 8);
    ctx.restore();
    if(!t.dead) {
        ctx.fillStyle = "#333"; ctx.fillRect(t.x-20, t.y+(t.id===0?30:-35), 40, 4);
        ctx.fillStyle = t.id===0?'#0f0':'#f00'; ctx.fillRect(t.x-20, t.y+(t.id===0?30:-35), (t.hp/3)*40, 4);
    }
}

function update() {
    if(!gameStarted) { requestAnimationFrame(update); return; }
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,cvs.width,cvs.height);
    
    // Препятствия для вертикального режима
    const walls = [
        {x: cvs.width/2-60, y: cvs.height/2-5, w: 120, h: 10},
        {x: 40, y: cvs.height/2-60, w: 10, h: 120},
        {x: cvs.width-50, y: cvs.height/2-60, w: 10, h: 120}
    ];
    ctx.fillStyle = '#222'; walls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));

    tanks.forEach(t => {
        if (!t.dead && (Math.abs(t.dx) > 0.05 || Math.abs(t.dy) > 0.05)) {
            let nX = t.x + t.dx * 3.5; let nY = t.y + t.dy * 3.5;
            if(!walls.some(w => nX+18 > w.x && nX-18 < w.x+w.w && nY+18 > w.y && nY-18 < w.y+w.h)) { t.x = nX; t.y = nY; }
            t.a = Math.atan2(t.dy, t.dx);
        }
        t.x = Math.max(20, Math.min(cvs.width-20, t.x));
        t.y = Math.max(20, Math.min(cvs.height-20, t.y));
        drawTank(t);
    });

    // Пули и коллизии
    for (let i = bullets.length-1; i >= 0; i--) {
        let b = bullets[i]; b.x += Math.cos(b.a)*10; b.y += Math.sin(b.a)*10;
        ctx.fillStyle = 'yellow'; ctx.beginPath(); ctx.arc(b.x, b.y, 3, 0, 7); ctx.fill();
        let hit = false;
        tanks.forEach(t => {
            if(!t.dead && b.owner !== t.id && Math.hypot(b.x-t.x, b.y-t.y) < 25) {
                t.hp--; hit = true;
                if(t.hp <= 0) {
                    t.dead = true; tanks[b.owner].s++;
                    document.getElementById('s'+(b.owner+1)).innerText = (b.owner===0?'Зеленый: ':'Красный: ') + tanks[b.owner].s;
                    setTimeout(() => { t.dead = false; t.hp = 3; t.x = cvs.width/2; t.y = t.id===0?cvs.height-60:60; }, 2000);
                }
            }
        });
        if(hit || b.x<0 || b.x>cvs.width || b.y<0 || b.y>cvs.height) bullets.splice(i,1);
    }
    requestAnimationFrame(update);
}

function setupJoy(joyId, idx) {
    const joy = document.getElementById(joyId); const stick = joy.firstElementChild;
    joy.onpointerdown = (e) => { joy.setPointerCapture(e.pointerId); };
    joy.onpointermove = (e) => {
        if(!joy.hasPointerCapture(e.pointerId)) return;
        const r = joy.getBoundingClientRect();
        const xRaw = e.clientX - (r.left + 50); const yRaw = e.clientY - (r.top + 50);
        const x = (idx === 1) ? -xRaw : xRaw; const y = (idx === 1) ? -yRaw : yRaw;
        const d = Math.min(35, Math.hypot(x,y)); const a = Math.atan2(y,x);
        stick.style.transform = `translate(${xRaw*(d/Math.hypot(xRaw,yRaw)||0)}px, ${yRaw*(d/Math.hypot(xRaw,yRaw)||0)}px)`;
        tanks[idx].dx = Math.cos(a)*(d/35); tanks[idx].dy = Math.sin(a)*(d/35);
    };
    joy.onpointerup = () => { stick.style.transform = ''; tanks[idx].dx = 0; tanks[idx].dy = 0; };
}
setupJoy('p1-joy', 0); setupJoy('p2-joy', 1);
const shoot = (idx) => { if(!tanks[idx].dead) bullets.push({x:tanks[idx].x+Math.cos(tanks[idx].a)*30, y:tanks[idx].y+Math.sin(tanks[idx].a)*30, a:tanks[idx].a, owner:idx}); };
document.getElementById('p1-fire').onpointerdown = (e) => { e.preventDefault(); shoot(0); };
document.getElementById('p2-fire').onpointerdown = (e) => { e.preventDefault(); shoot(1); };

resize(); update();
</script>
</body>
</html>
