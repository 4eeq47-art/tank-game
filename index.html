<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ТАНКИ: ГЕН-27 (СТРОЕВОЙ ШАГ)</title>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: 'Courier New', monospace; color: white; }
        canvas { display: block; background: linear-gradient(to bottom, #0d121d 0%, #000 100%); }
        #gen-num { position: fixed; top: 10px; left: 10px; font-size: 14px; z-index: 10; font-weight: bold; text-shadow: 1px 1px 2px #000; }
        #lib-btn { position: fixed; top: 10px; right: 10px; z-index: 100; padding: 6px 18px; background: #3e4432; color: #fff; border: 2px solid #fff; cursor: pointer; font-weight: bold; }
        
        #library-overlay { 
            position: fixed; inset: 0; background: rgba(5, 7, 10, 0.98); z-index: 200; 
            display: none; padding: 30px; overflow-y: auto;
        }
        .lib-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .archive-card { background: #151812; border: 1px solid #4a5040; padding: 15px; margin-bottom: 20px; }
        .specs { font-size: 11px; color: #a0a0a0; margin-top: 10px; line-height: 1.4; }
        canvas.prev { background: #000; display: block; margin: 10px auto; border: 1px solid #3e4432; }
        .close-lib { float: right; cursor: pointer; color: #ff4444; font-weight: bold; border: 1px solid; padding: 5px; }
    </style>
</head>
<body>

<div id="gen-num">ГЕНЕРАЦИЯ №27</div>
<button id="lib-btn" onclick="toggleLib()">БИБЛИОТЕКА</button>

<div id="library-overlay">
    <span class="close-lib" onclick="toggleLib()">[В БОЙ]</span>
    <h1 style="color: #3e5c36;">АРХИВ ТЕХНИКИ И ХАРАКТЕРИСТИК</h1>
    <div class="lib-grid">
        <div class="lib-section">
            <h2 style="color: #888;">ЛЮФТВАФФЕ (ГЕН-27)</h2>
            <div class="archive-card">
                <canvas id="p-curr" class="prev" width="220" height="100"></canvas>
                <div class="specs">
                    <b>Модели:</b> Ju-52 (Бомбардировщик), Hs-129 (Штурмовик)<br>
                    <b>Особенности:</b> Маловысотный полет, замедление 30%, очереди трассеров.
                </div>
            </div>
        </div>
        <div class="lib-section">
            <h2 style="color: #888;">ПАНЦЕРВАФФЕ (ГЕН-27)</h2>
            <div class="archive-card">
                <canvas id="t-curr" class="prev" width="220" height="100"></canvas>
                <div class="specs">
                    <b>Тип:</b> Тяжелый танк прорыва<br>
                    <b>Орудие:</b> 88-мм (без обводки ствола)<br>
                    <b>Ходовая:</b> Активные катки (6 шт.), вынос вспышки +85.
                </div>
            </div>
        </div>
    </div>
</div>

<canvas id="battleCanvas"></canvas>

<script>
const canvas = document.getElementById('battleCanvas');
const ctx = canvas.getContext('2d');
let W, H, audioCtx, marchMasterGain;

const vehicles = [], planes = [], bombs = [], bullets = [], explosions = [], tankFlashes = [];

function initAudio() {
    if(!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        marchMasterGain = audioCtx.createGain();
        marchMasterGain.gain.value = 0.2; 
        marchMasterGain.connect(audioCtx.destination);
        startStepMarch();
    }
}

// Ритмичный марш сапог по твоему образцу
function startStepMarch() {
    let beat = 0;
    setInterval(() => {
        if(audioCtx.state === 'suspended') return;
        const now = audioCtx.currentTime;
        
        // 1. Глухой удар (Низкие частоты сапога)
        const kick = audioCtx.createOscillator();
        const kGain = audioCtx.createGain();
        kick.frequency.setValueAtTime(55, now);
        kick.frequency.exponentialRampToValueAtTime(30, now + 0.15);
        kGain.gain.setValueAtTime(0.15, now);
        kGain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        kick.connect(kGain); kGain.connect(marchMasterGain);
        kick.start(); kick.stop(now + 0.2);

        // 2. Хруст/Топ (Шум)
        const noise = audioCtx.createBufferSource();
        const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.1, audioCtx.sampleRate);
        const data = buf.getChannelData(0);
        for(let i=0; i<data.length; i++) data[i] = (Math.random() * 2 - 1) * 0.2;
        noise.buffer = buf;
        const nFilter = audioCtx.createBiquadFilter();
        nFilter.type = 'lowpass'; nFilter.frequency.value = 1000;
        const nGain = audioCtx.createGain();
        nGain.gain.setValueAtTime(0.08, now);
        nGain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        noise.connect(nFilter); nFilter.connect(nGain); nGain.connect(marchMasterGain);
        noise.start();

        // 3. Басовый акцент на 1 и 3 долю
        if(beat % 2 === 0) {
            const bass = audioCtx.createOscillator();
            bass.type = 'square'; bass.frequency.value = 41.20; // Ми (E1)
            const bg = audioCtx.createGain();
            bg.gain.setValueAtTime(0.03, now); bg.gain.linearRampToValueAtTime(0, now + 0.4);
            bass.connect(bg); bg.connect(marchMasterGain);
            bass.start(); bass.stop(now + 0.4);
        }
        beat++;
    }, 550); 
}

class Tank {
    constructor(y, speed, scale, color, z) {
        this.x = Math.random() * W; this.y = y; this.speed = speed; this.scale = scale; this.color = color; this.z = z;
        this.wAngle = 0; this.fireT = 150 + Math.random() * 300;
    }
    update() {
        this.x += this.speed; this.wAngle += this.speed * 0.15;
        if(this.x > W + 200) this.x = -200;
        if(--this.fireT < 0) {
            tankFlashes.push({x: this.x + 85*this.scale, y: this.y - 15*this.scale, l: 1.0, s: this.scale});
            this.fireT = 250 + Math.random() * 400;
        }
    }
    draw(tCtx = ctx, tx = this.x, ty = this.y, ts = this.scale, tw = this.wAngle) {
        tCtx.save(); tCtx.translate(tx, ty); tCtx.scale(ts, ts);
        tCtx.fillStyle = '#111'; tCtx.beginPath(); tCtx.roundRect(-45, 8, 90, 18, 4); tCtx.fill();
        tCtx.fillStyle = '#333'; tCtx.strokeStyle = '#555'; 
        for(let i = -35; i <= 35; i += 14) {
            tCtx.save(); tCtx.translate(i, 18); tCtx.rotate(tw);
            tCtx.beginPath(); tCtx.arc(0,0,6,0,7); tCtx.fill(); tCtx.stroke();
            tCtx.beginPath(); tCtx.moveTo(-3,0); tCtx.lineTo(3,0); tCtx.stroke(); tCtx.restore();
        }
        tCtx.fillStyle = this.color; tCtx.beginPath(); tCtx.moveTo(-45,10); tCtx.lineTo(-40,-5); tCtx.lineTo(35,-5); tCtx.lineTo(45,10); tCtx.fill();
        tCtx.save(); tCtx.translate(-5, -5); tCtx.beginPath(); tCtx.arc(0,0,18,Math.PI,0); tCtx.fill();
        tCtx.fillStyle = '#111'; tCtx.fillRect(15, -10, 50, 6); tCtx.restore(); tCtx.restore();
    }
}

class Plane {
    constructor(y, speed, type, z) {
        this.x = W + 400; this.y = y; this.baseY = y; this.speed = speed * 0.35; 
        this.type = type; this.z = z; this.timer = Math.random()*10;
    }
    update() {
        this.x -= this.speed; this.timer += 0.04;
        let wave = Math.sin(this.timer);
        this.y = this.baseY + wave * 30;
        if(this.type === 'fighter' && Math.random() < 0.45) {
            bullets.push({x: this.x - 45, y: this.y + 12, a: wave*0.28, v: 24, l: 45});
        } else if(this.type === 'bomber' && Math.random() < 0.006) {
            bombs.push({x:this.x, y:this.y, vy:1, z:this.z});
        }
        if(this.x < -500) this.x = W + 500;
    }
    draw(tCtx = ctx, tx = this.x, ty = this.y, ts = this.z) {
        tCtx.save(); tCtx.translate(tx, ty); tCtx.scale(ts, ts);
        tCtx.fillStyle = '#3e4432'; tCtx.fillRect(-12, -8, 28, 14); 
        if(this.type === 'bomber') tCtx.fillRect(-70, -5, 120, 16); 
        else tCtx.fillRect(-50, 0, 100, 11);
        tCtx.restore();
    }
}

function playExp(z) {
    if(!audioCtx) return;
    const n = audioCtx.createBufferSource();
    const b = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.8, audioCtx.sampleRate);
    const d = b.getChannelData(0); for(let i=0; i<d.length; i++) d[i] = Math.random() * 2 - 1;
    n.buffer = b; const g = audioCtx.createGain(); const f = audioCtx.createBiquadFilter();
    f.type = 'lowpass'; f.frequency.value = 45 * z; g.gain.value = 0.6 * z;
    n.connect(f); f.connect(g); g.connect(audioCtx.destination); n.start();
}

function toggleLib() {
    const l = document.getElementById('library-overlay');
    const isVisible = l.style.display === 'block';
    l.style.display = isVisible ? 'none' : 'block';
    if(marchMasterGain) marchMasterGain.gain.value = isVisible ? 0.2 : 0.05;

    if(!isVisible) {
        const tc = document.getElementById('t-curr').getContext('2d');
        const pc = document.getElementById('p-curr').getContext('2d');
        tc.clearRect(0,0,220,100); pc.clearRect(0,0,220,100);
        vehicles[2].draw(tc, 110, 50, 1.3, 0);
        planes[0].draw(pc, 110, 45, 1.1);
    }
}

function resize() {
    W = window.innerWidth; H = window.innerHeight; canvas.width = W; canvas.height = H;
    vehicles.length = 0; planes.length = 0;
    vehicles.push(new Tank(H-160, 0.7, 0.5, '#1e2a1a', 0.5));
    vehicles.push(new Tank(H-110, 1.1, 0.8, '#2d4028', 0.8));
    vehicles.push(new Tank(H-55, 1.7, 1.25, '#3e5c36', 1.2));
    planes.push(new Plane(H*0.2, 4, 'bomber', 0.8));
    planes.push(new Plane(H*0.4, 7, 'fighter', 1.1));
}

function loop() {
    ctx.clearRect(0,0,W,H);
    planes.forEach(p => { p.update(); p.draw(); });
    vehicles.forEach(v => { v.update(); v.draw(); });
    
    bullets.forEach((b, i) => {
        ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2.5;
        ctx.beginPath(); ctx.moveTo(b.x, b.y);
        b.x -= Math.cos(b.a)*b.v; b.y -= Math.sin(b.a)*b.v;
        ctx.lineTo(b.x, b.y); ctx.stroke();
        if(b.l-- < 0) bullets.splice(i,1);
    });

    tankFlashes.forEach((f, i) => {
        let grad = ctx.createRadialGradient(f.x, f.y, 0, f.x, f.y, 40*f.s);
        grad.addColorStop(0, `rgba(255, 255, 0, ${f.l})`);
        grad.addColorStop(0.3, `rgba(255, 100, 0, ${f.l*0.7})`);
        grad.addColorStop(1, 'transparent');
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(f.x, f.y, 40*f.s, 0, 7); ctx.fill();
        f.l -= 0.12; if(f.l <= 0) tankFlashes.splice(i, 1);
    });

    bombs.forEach((b, i) => {
        b.y += b.vy; b.vy += 0.12;
        ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, 7); ctx.fill();
        let gr = b.z < 0.7 ? H-160 : (b.z < 1 ? H-110 : H-55);
        if(b.y > gr) { 
            explosions.push({x:b.x, y:b.y, s:b.z, l:1.0}); 
            playExp(b.z); bombs.splice(i,1); 
        }
    });

    explosions.forEach((ex, i) => {
        ctx.save(); ctx.globalAlpha = ex.l; ctx.fillStyle = '#ff4500';
        ctx.beginPath(); ctx.ellipse(ex.x, ex.y, 80*ex.s*(1.2-ex.l), 20*ex.s*(1.2-ex.l), 0, 0, 7);
        ctx.fill(); ctx.restore();
        ex.l -= 0.04; if(ex.l <= 0) explosions.splice(i, 1);
    });

    requestAnimationFrame(loop);
}

window.addEventListener('mousedown', initAudio);
window.addEventListener('resize', resize);
resize(); loop();
</script>
</body>
</html>
